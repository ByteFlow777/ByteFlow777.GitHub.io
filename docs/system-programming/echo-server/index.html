<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="echo 服务器 # 辅助函数 # panic 函数用于错误处理，当发生错误时，调用 exit 函数直接退出程序。
void panic(const char *format, ...) { va_list args; va_start(args, format); vfprintf(stderr, format, args); va_end(args); exit(EXIT_FAILURE); } readn 和 writen 函数分别用于从 fd 处读和写 n 个字节。
ssize_t readn(int fd, const void *buf, size_t n) { ssize_t nread; while (nleft > 0) { if ((nread = read(fd, buf, nleft)) < 0) { if (nleft == n) { return -1; // error, return -1 } else { break; // error, return amount read so far } while (nleft > 0) { if ((nread = read(fd, buf, nleft)) < 0) { if (nleft == n) { return -1; // error, return -1 } else { } nleft -= nread; buf += nread; } return n - nleft; } ssize_t writen(int fd, const void *buf, size_t n) { size_t nleft = n; ssize_t nwritten; while (nleft > 0) { if ((nwritten = write(fd, buf, nleft)) < 0) { if (nleft == n) { return -1; } else { break; } } else if (nwritten == 0) { break; } nleft -= nwritten; buf += nwritten; } return n - nleft; } read_line 函数用于从用户处读取一行输入。"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://ileonli.github.io/docs/system-programming/echo-server/"><meta property="og:site_name" content="Leon' Blog"><meta property="og:title" content="echo 服务器"><meta property="og:description" content="echo 服务器 # 辅助函数 # panic 函数用于错误处理，当发生错误时，调用 exit 函数直接退出程序。
void panic(const char *format, ...) { va_list args; va_start(args, format); vfprintf(stderr, format, args); va_end(args); exit(EXIT_FAILURE); } readn 和 writen 函数分别用于从 fd 处读和写 n 个字节。
ssize_t readn(int fd, const void *buf, size_t n) { ssize_t nread; while (nleft > 0) { if ((nread = read(fd, buf, nleft)) < 0) { if (nleft == n) { return -1; // error, return -1 } else { break; // error, return amount read so far } while (nleft > 0) { if ((nread = read(fd, buf, nleft)) < 0) { if (nleft == n) { return -1; // error, return -1 } else { } nleft -= nread; buf += nread; } return n - nleft; } ssize_t writen(int fd, const void *buf, size_t n) { size_t nleft = n; ssize_t nwritten; while (nleft > 0) { if ((nwritten = write(fd, buf, nleft)) < 0) { if (nleft == n) { return -1; } else { break; } } else if (nwritten == 0) { break; } nleft -= nwritten; buf += nwritten; } return n - nleft; } read_line 函数用于从用户处读取一行输入。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-07-25T22:58:20+08:00"><title>echo 服务器 | Leon' Blog</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.min.c4648f90e7f239143d6b1f74326dc2ce1794185b23b8cbbf3f813cfdf5d576ca.css integrity="sha256-xGSPkOfyORQ9ax90Mm3CzheUGFsjuMu/P4E8/fXVdso=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.d2f3ad9d3c321af6e11880a5fd0f989f68955447a182eef331b2191d1edae1ea.js integrity="sha256-0vOtnTwyGvbhGICl/Q+Yn2iVVEehgu7zMbIZHR7a4eo=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-EL04QEY330"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EL04QEY330")}</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Leon' Blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-dfc62bc51fd10e15afc9a11c29a21438 class=toggle>
<label for=section-dfc62bc51fd10e15afc9a11c29a21438 class="flex justify-between"><a role=button>Java</a></label><ul><li><a href=/docs/Java/Agent/>Agent</a></li><li><a href=/docs/Java/Cleaner/>Cleaner 类</a></li><li><a href=/docs/Java/DynamicProxy/>动态代理</a></li></ul></li><li><input type=checkbox id=section-dd174040a908659982d53d695ff59f6c class=toggle>
<label for=section-dd174040a908659982d53d695ff59f6c class="flex justify-between"><a role=button>JVM</a></label><ul><li><a href=/docs/JVM/AsmTools/>AsmTools</a></li><li><a href=/docs/JVM/loading-linking-initializing/>JVM 加载-链接-初始化</a></li><li><input type=checkbox id=section-8116e10cba9ea1a7d22332ccf696967c class=toggle>
<label for=section-8116e10cba9ea1a7d22332ccf696967c class="flex justify-between"><a role=button>字节码</a></label><ul><li><a href=/docs/JVM/ByteCode/ClassFile/>Class 文件结构</a></li><li><a href=/docs/JVM/ByteCode/constant_pool/>常量池</a></li></ul></li></ul></li><li><input type=checkbox id=section-322adad93406759f98a33491e2ecc8af class=toggle checked>
<label for=section-322adad93406759f98a33491e2ecc8af class="flex justify-between"><a role=button>Linux 网络编程</a></label><ul><li><a href=/docs/system-programming/network-byte-order/>网络字节序</a></li><li><a href=/docs/system-programming/address-families/>网络地址族</a></li><li><a href=/docs/system-programming/block-and-nonblock-io/>（非）阻塞 I/O</a></li><li><a href=/docs/system-programming/multiplexing/>I/O 多路复用</a></li><li><a href=/docs/system-programming/reactor-pattern/>Reactor 模型</a></li><li><a href=/docs/system-programming/sockets/>套接字（socket）</a></li><li><a href=/docs/system-programming/echo-server/ class=active>echo 服务器</a></li></ul></li><li><input type=checkbox id=section-be784f006af4b056e801791bd4131884 class=toggle>
<label for=section-be784f006af4b056e801791bd4131884 class="flex justify-between"><a role=button>MyBatis</a></label><ul><li><a href=/docs/MyBatis/SqlSession/>SqlSession</a></li><li><a href=/docs/MyBatis/Executor/>Executor</a></li></ul></li><li><input type=checkbox id=section-8e8ae3b760618e1158c1946d2d023ca5 class=toggle>
<label for=section-8e8ae3b760618e1158c1946d2d023ca5 class="flex justify-between"><a role=button>Netty</a></label><ul><li><a href=/docs/Netty/ByteBuf/>ByteBuf</a></li><li><a href=/docs/Netty/EventLoop/>EventLoop</a></li><li><a href=/docs/Netty/EventLoopGroup/>EventLoopGroup</a></li><li><a href=/docs/Netty/Channel/>Channel</a></li><li><a href=/docs/Netty/ChannelHandler/>ChannelHandler</a></li><li><a href=/docs/Netty/encoder-and-decoder/>编码器和解码器</a></li></ul></li><li><input type=checkbox id=section-bccb031e3769927ed8f05e90efe74959 class=toggle>
<label for=section-bccb031e3769927ed8f05e90efe74959 class="flex justify-between"><a role=button>Pro Git</a></label><ul><li><a href=/docs/ProGit/Git-%E5%9F%BA%E7%A1%80/>Git 基础</a></li><li><a href=/docs/ProGit/Git-%E5%88%86%E6%94%AF/>Git 分支</a></li></ul></li><li><span>计算机网络</span><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>echo 服务器</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#echo-服务器>echo 服务器</a><ul><li><a href=#辅助函数>辅助函数</a></li><li><a href=#客户端>客户端</a></li><li><a href=#为什么多路复用需要搭配非阻塞>为什么多路复用需要搭配非阻塞</a></li><li><a href=#普通版本>普通版本</a></li><li><a href=#select-版本>select 版本</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=echo-服务器>echo 服务器
<a class=anchor href=#echo-%e6%9c%8d%e5%8a%a1%e5%99%a8>#</a></h1><h2 id=辅助函数>辅助函数
<a class=anchor href=#%e8%be%85%e5%8a%a9%e5%87%bd%e6%95%b0>#</a></h2><p><code>panic</code> 函数用于错误处理，当发生错误时，调用 <code>exit</code> 函数直接退出程序。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>panic</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>format, ...) {
</span></span><span style=display:flex><span>  va_list args;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>va_start</span>(args, format);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vfprintf</span>(stderr, format, args);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>va_end</span>(args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exit</span>(EXIT_FAILURE);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>readn</code> 和 <code>writen</code> 函数分别用于从 <code>fd</code> 处读和写 <code>n</code> 个字节。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>readn</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>buf, <span style=color:#66d9ef>size_t</span> n) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ssize_t</span> nread;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (nleft <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ((nread <span style=color:#f92672>=</span> <span style=color:#a6e22e>read</span>(fd, buf, nleft)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (nleft <span style=color:#f92672>==</span> n) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#75715e>// error, return -1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>; <span style=color:#75715e>// error, return amount read so far
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (nleft <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ((nread <span style=color:#f92672>=</span> <span style=color:#a6e22e>read</span>(fd, buf, nleft)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (nleft <span style=color:#f92672>==</span> n) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#75715e>// error, return -1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    nleft <span style=color:#f92672>-=</span> nread;
</span></span><span style=display:flex><span>    buf <span style=color:#f92672>+=</span> nread;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> n <span style=color:#f92672>-</span> nleft;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>writen</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>buf, <span style=color:#66d9ef>size_t</span> n) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>size_t</span> nleft <span style=color:#f92672>=</span> n;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ssize_t</span> nwritten;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (nleft <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ((nwritten <span style=color:#f92672>=</span> <span style=color:#a6e22e>write</span>(fd, buf, nleft)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (nleft <span style=color:#f92672>==</span> n) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (nwritten <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    nleft <span style=color:#f92672>-=</span> nwritten;
</span></span><span style=display:flex><span>    buf <span style=color:#f92672>+=</span> nwritten;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> n <span style=color:#f92672>-</span> nleft;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>read_line</code> 函数用于从用户处读取一行输入。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>read_line</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>line <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>size_t</span> buf_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ssize_t</span> n_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>getline</span>(<span style=color:#f92672>&amp;</span>line, <span style=color:#f92672>&amp;</span>buf_size, stdin);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (n_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;error: reading input</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (line[n_bytes <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;\n&#39;</span>) {
</span></span><span style=display:flex><span>    line[n_bytes <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> line;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>set_nonblocking</code> 函数用于将 <code>fd</code> 设为非阻塞模式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>set_nonblocking</span>(<span style=color:#66d9ef>int</span> fd) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> flags <span style=color:#f92672>=</span> <span style=color:#a6e22e>fcntl</span>(fd, F_GETFL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (flags <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>fcntl</span>(fd, F_SETFL, flags <span style=color:#f92672>|</span> O_NONBLOCK) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>create_sockaddr_in</code> 函数用于创建 <code>struct sockaddr_in</code> 结构体。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>struct</span> sockaddr_in <span style=color:#f92672>*</span><span style=color:#a6e22e>create_sockaddr_in</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>address, <span style=color:#66d9ef>int</span> port) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> sockaddr_in <span style=color:#f92672>*</span>addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> sockaddr_in));
</span></span><span style=display:flex><span>  addr<span style=color:#f92672>-&gt;</span>sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>  addr<span style=color:#f92672>-&gt;</span>sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(address);
</span></span><span style=display:flex><span>  addr<span style=color:#f92672>-&gt;</span>sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(port);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> addr;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>对于 <code>socket</code>、<code>bind</code>、<code>listen</code>、<code>accept</code> 和 <code>connect</code> 函数，大部分使用都是一样的，对其进行封装。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>Socket</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;socket() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> fd;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>Bind</span>(<span style=color:#66d9ef>int</span> socket_fd, <span style=color:#66d9ef>struct</span> sockaddr_in <span style=color:#f92672>*</span>addr) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>bind</span>(socket_fd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)(addr), <span style=color:#66d9ef>sizeof</span>(<span style=color:#f92672>*</span>addr));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;bind() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>Listen</span>(<span style=color:#66d9ef>int</span> socket_fd) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>listen</span>(socket_fd, <span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;listen() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>Accept</span>(<span style=color:#66d9ef>int</span> socket_fd, <span style=color:#66d9ef>struct</span> sockaddr_in <span style=color:#f92672>*</span>addr, <span style=color:#66d9ef>socklen_t</span> <span style=color:#f92672>*</span>addr_len) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>accept</span>(socket_fd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)addr, addr_len);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;accept() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>set_nonblocking</span>(fd);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;set_nonblocking error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> fd;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>Connect</span>(<span style=color:#66d9ef>int</span> socket_fd, <span style=color:#66d9ef>struct</span> sockaddr_in <span style=color:#f92672>*</span>addr) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>connect</span>(socket_fd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)(addr), <span style=color:#66d9ef>sizeof</span>(<span style=color:#f92672>*</span>addr));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;connect() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=客户端>客户端
<a class=anchor href=#%e5%ae%a2%e6%88%b7%e7%ab%af>#</a></h2><p>客户端读取一行用户的输入，将数据传给服务器，服务器将所有的字母大写后再传给客户端。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run_client</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>remote_address, <span style=color:#66d9ef>int</span> remote_port) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> client_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>Socket</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> sockaddr_in <span style=color:#f92672>*</span>server_addr <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>create_sockaddr_in</span>(remote_address, remote_port);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Connect</span>(client_fd, server_addr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>input <span style=color:#f92672>=</span> <span style=color:#a6e22e>read_line</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> input_len <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(input);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> buf[input_len <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (input_len <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>goto</span> out;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> sent_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>send</span>(client_fd, input, input_len, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sent_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;send() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> recv_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>recv</span>(client_fd, buf, input_len, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (recv_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;recv() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, buf);
</span></span><span style=display:flex><span>  out:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>free</span>(input);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=为什么多路复用需要搭配非阻塞>为什么多路复用需要搭配非阻塞
<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%a4%9a%e8%b7%af%e5%a4%8d%e7%94%a8%e9%9c%80%e8%a6%81%e6%90%ad%e9%85%8d%e9%9d%9e%e9%98%bb%e5%a1%9e>#</a></h2><pre tabindex=0><code>On Linux, select() may report a socket file descriptor as &#34;ready
for reading&#34;, while nevertheless a subsequent read blocks.  This
could for example happen when data has arrived but upon
examination has the wrong checksum and is discarded.  There may
be other circumstances in which a file descriptor is spuriously
reported as ready.  Thus it may be safer to use O_NONBLOCK on
sockets that should not block.
</code></pre><p>参考链接：
<a href="https://man7.org/linux/man-pages/man2/select.2.html#:~:text=On%20Linux%2C%20select%28%29%20may,sockets%20that%20should%20not%20block.">select</a></p><h2 id=普通版本>普通版本
<a class=anchor href=#%e6%99%ae%e9%80%9a%e7%89%88%e6%9c%ac>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;ctype.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdarg.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;arpa/inet.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> used_for_cleanup_fd <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>panic</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>format, ...) {
</span></span><span style=display:flex><span>  va_list args;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>va_start</span>(args, format);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vfprintf</span>(stderr, format, args);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>va_end</span>(args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exit</span>(EXIT_FAILURE);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cleanup</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (used_for_cleanup_fd <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>close</span>(used_for_cleanup_fd);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run_client</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>remote_address, <span style=color:#66d9ef>int</span> remote_port) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> ret;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>512</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> client_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (client_fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;socket() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>atexit</span>(cleanup);
</span></span><span style=display:flex><span>  used_for_cleanup_fd <span style=color:#f92672>=</span> client_fd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> sockaddr_in server_addr;
</span></span><span style=display:flex><span>  server_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>  server_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(remote_address);
</span></span><span style=display:flex><span>  server_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(remote_port);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>connect</span>(client_fd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>server_addr),
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>sizeof</span>(server_addr));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;connect() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fgets</span>(buf, <span style=color:#66d9ef>sizeof</span>(buf), stdin);
</span></span><span style=display:flex><span>    buf[<span style=color:#a6e22e>strcspn</span>(buf, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> buf_len <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(buf);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (buf_len <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (buf_len <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>sizeof</span>(buf) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;input too long</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> sent_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>send</span>(client_fd, buf, buf_len, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sent_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;send() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> recv_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>recv</span>(client_fd, buf, <span style=color:#66d9ef>sizeof</span>(buf), <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (recv_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;recv() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, buf);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run_server</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>address, <span style=color:#66d9ef>int</span> port) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> ret;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>512</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> sockaddr_in server_addr;
</span></span><span style=display:flex><span>  server_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>  server_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(address);
</span></span><span style=display:flex><span>  server_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(port);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> server_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (server_fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;socket() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>atexit</span>(cleanup);
</span></span><span style=display:flex><span>  used_for_cleanup_fd <span style=color:#f92672>=</span> server_fd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>bind</span>(server_fd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>server_addr), <span style=color:#66d9ef>sizeof</span>(server_addr));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;bind() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>listen</span>(server_fd, <span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;listen() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> sockaddr_in client_addr;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>socklen_t</span> client_addr_len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(client_addr);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> client_fd <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>accept</span>(server_fd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>client_addr), <span style=color:#f92672>&amp;</span>client_addr_len);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (client_fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;accept() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>ssize_t</span> read_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>recv</span>(client_fd, buf, <span style=color:#66d9ef>sizeof</span>(buf), <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (read_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;recv() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (read_bytes <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(client_fd);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>ssize_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> read_bytes; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        buf[i] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span>)<span style=color:#a6e22e>toupper</span>((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span>)buf[i]);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>ssize_t</span> sent_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>send</span>(client_fd, buf, read_bytes, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (sent_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;send() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[]) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (argc <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;usage: &lt;mode&gt; &lt;IP&gt; &lt;port&gt;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>mode <span style=color:#f92672>=</span> argv[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>address <span style=color:#f92672>=</span> argv[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> port <span style=color:#f92672>=</span> <span style=color:#a6e22e>atoi</span>(argv[<span style=color:#ae81ff>3</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strncmp</span>(mode, <span style=color:#e6db74>&#34;client&#34;</span>, <span style=color:#ae81ff>6</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>run_client</span>(address, port);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strncmp</span>(mode, <span style=color:#e6db74>&#34;server&#34;</span>, <span style=color:#ae81ff>6</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>run_server</span>(address, port);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=select-版本>select 版本
<a class=anchor href=#select-%e7%89%88%e6%9c%ac>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;ctype.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;errno.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdarg.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;arpa/inet.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/select.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAX(a, b) a &lt; b ? b : a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> used_for_cleanup_fd <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>panic</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>format, ...) {
</span></span><span style=display:flex><span>  va_list args;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>va_start</span>(args, format);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vfprintf</span>(stderr, format, args);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>va_end</span>(args);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>exit</span>(EXIT_FAILURE);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cleanup</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (used_for_cleanup_fd <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>close</span>(used_for_cleanup_fd);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run_client</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>remote_address, <span style=color:#66d9ef>int</span> remote_port) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> ret;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>512</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> client_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (client_fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;socket() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>atexit</span>(cleanup);
</span></span><span style=display:flex><span>  used_for_cleanup_fd <span style=color:#f92672>=</span> client_fd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> sockaddr_in server_addr;
</span></span><span style=display:flex><span>  server_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>  server_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(remote_address);
</span></span><span style=display:flex><span>  server_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(remote_port);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>connect</span>(client_fd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>server_addr),
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>sizeof</span>(server_addr));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;connect() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fgets</span>(buf, <span style=color:#66d9ef>sizeof</span>(buf), stdin);
</span></span><span style=display:flex><span>    buf[<span style=color:#a6e22e>strcspn</span>(buf, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> buf_len <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(buf);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (buf_len <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (buf_len <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>sizeof</span>(buf) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;input too long</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> sent_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>send</span>(client_fd, buf, buf_len, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sent_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;send() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssize_t</span> recv_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>recv</span>(client_fd, buf, <span style=color:#66d9ef>sizeof</span>(buf), <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (recv_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;recv() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, buf);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run_server</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>address, <span style=color:#66d9ef>int</span> port) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> ret;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>512</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> sockaddr_in server_addr;
</span></span><span style=display:flex><span>  server_addr.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>  server_addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(address);
</span></span><span style=display:flex><span>  server_addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(port);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> server_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (server_fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;socket() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>atexit</span>(cleanup);
</span></span><span style=display:flex><span>  used_for_cleanup_fd <span style=color:#f92672>=</span> server_fd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>bind</span>(server_fd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>server_addr), <span style=color:#66d9ef>sizeof</span>(server_addr));
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;bind() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>listen</span>(server_fd, <span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;listen() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> sockaddr_in client_addr;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>socklen_t</span> client_addr_len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(client_addr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  fd_set fds;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FD_ZERO</span>(<span style=color:#f92672>&amp;</span>fds);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FD_SET</span>(server_fd, <span style=color:#f92672>&amp;</span>fds);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> max_fd <span style=color:#f92672>=</span> server_fd;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (;;) {
</span></span><span style=display:flex><span>    fd_set rfds <span style=color:#f92672>=</span> fds;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> retval <span style=color:#f92672>=</span> <span style=color:#a6e22e>select</span>(max_fd <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&amp;</span>rfds, NULL, NULL, NULL);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (retval <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;select() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>FD_ISSET</span>(server_fd, <span style=color:#f92672>&amp;</span>rfds)) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// new connection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>int</span> client_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>accept</span>(server_fd, (<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>client_addr),
</span></span><span style=display:flex><span>                             <span style=color:#f92672>&amp;</span>client_addr_len);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (client_fd <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;accept() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>FD_SET</span>(client_fd, <span style=color:#f92672>&amp;</span>fds);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      max_fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>MAX</span>(max_fd, client_fd);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (retval <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> server_fd <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>; fd <span style=color:#f92672>&lt;=</span> max_fd; fd<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>FD_ISSET</span>(fd, <span style=color:#f92672>&amp;</span>rfds)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ssize_t</span> read_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>recv</span>(fd, buf, <span style=color:#66d9ef>sizeof</span>(buf), <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (read_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;recv() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (read_bytes <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>FD_CLR</span>(fd, <span style=color:#f92672>&amp;</span>fds);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>close</span>(fd);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>ssize_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> read_bytes; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>          buf[i] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span>)<span style=color:#a6e22e>toupper</span>((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span>)buf[i]);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ssize_t</span> sent_bytes <span style=color:#f92672>=</span> <span style=color:#a6e22e>send</span>(fd, buf, read_bytes, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sent_bytes <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;send() error: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>argv[]) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (argc <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>4</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>panic</span>(<span style=color:#e6db74>&#34;usage: &lt;mode&gt; &lt;IP&gt; &lt;port&gt;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>mode <span style=color:#f92672>=</span> argv[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>address <span style=color:#f92672>=</span> argv[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> port <span style=color:#f92672>=</span> <span style=color:#a6e22e>atoi</span>(argv[<span style=color:#ae81ff>3</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strncmp</span>(mode, <span style=color:#e6db74>&#34;client&#34;</span>, <span style=color:#ae81ff>6</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>run_client</span>(address, port);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>strncmp</span>(mode, <span style=color:#e6db74>&#34;server&#34;</span>, <span style=color:#ae81ff>6</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>run_server</span>(address, port);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#echo-服务器>echo 服务器</a><ul><li><a href=#辅助函数>辅助函数</a></li><li><a href=#客户端>客户端</a></li><li><a href=#为什么多路复用需要搭配非阻塞>为什么多路复用需要搭配非阻塞</a></li><li><a href=#普通版本>普通版本</a></li><li><a href=#select-版本>select 版本</a></li></ul></li></ul></nav></div></aside></main></body></html>