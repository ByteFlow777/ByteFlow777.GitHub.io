<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Lab 1 Exercise 1 Exercise 1 需要我们完成以下文件的代码：
 src/java/simpledb/storage/TupleDesc.java src/java/simpledb/storage/Tuple.java  User 表如下所示：
id(INT) name(STRING) age(INT) 1 &quot;张三&quot; 12 2 &quot;李四&quot; 22 3 &quot;王二&quot; 54 Tuple.java 表示表中的某一行数据，如：User(1, &ldquo;张三&rdquo;, 12), User(2, &ldquo;李四&rdquo;, 22)
TupleDesc.java 表示表中字段的类型和名称，如：User{id(INT), name(STRING), age(INT)}
TupleDesc.java TupleDesc.java 中的静态内部类 TDItem 用于表示某字段的类型（Type fieldType）和名称（String fieldName）。
public static class TDItem implements Serializable { private static final long serialVersionUID = 1L; /** * The type of the field */ public final Type fieldType; /** * The name of the field */ public final String fieldName; public TDItem(Type t, String n) { this.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Lab 1" />
<meta property="og:description" content="Lab 1 Exercise 1 Exercise 1 需要我们完成以下文件的代码：
 src/java/simpledb/storage/TupleDesc.java src/java/simpledb/storage/Tuple.java  User 表如下所示：
id(INT) name(STRING) age(INT) 1 &quot;张三&quot; 12 2 &quot;李四&quot; 22 3 &quot;王二&quot; 54 Tuple.java 表示表中的某一行数据，如：User(1, &ldquo;张三&rdquo;, 12), User(2, &ldquo;李四&rdquo;, 22)
TupleDesc.java 表示表中字段的类型和名称，如：User{id(INT), name(STRING), age(INT)}
TupleDesc.java TupleDesc.java 中的静态内部类 TDItem 用于表示某字段的类型（Type fieldType）和名称（String fieldName）。
public static class TDItem implements Serializable { private static final long serialVersionUID = 1L; /** * The type of the field */ public final Type fieldType; /** * The name of the field */ public final String fieldName; public TDItem(Type t, String n) { this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://byteflow777.github.io/docs/lab-report/MIT-6.830/lab1/" />

<title>Lab 1 | Leon&#39;s Blog</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.e64941ea1e016857b0671fc48c928b19cfd47ec0fad3e7bb5697d6bb6c74cb7d.css" integrity="sha256-5klB6h4BaFewZx/EjJKLGc/UfsD60&#43;e7VpfWu2x0y30=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.4aea7bd5c3c3403c2f59353dfc1af22fe140099d96629386a4e3a71496ad508c.js" integrity="sha256-Sup71cPDQDwvWTU9/BryL&#43;FACZ2WYpOGpOOnFJatUIw=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.74a8bb07f0bee86d6bb9a2750f073f14d93c7e4512f28860370cfd879e9719b4.js" integrity="sha256-dKi7B/C&#43;6G1ruaJ1Dwc/FNk8fkUS8ohgNwz9h56XGbQ=" crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'G-Y0393EVXVY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Leon&#39;s Blog</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Program Language</span>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Data structure</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/data-structure/avl-tree/" class="">AVL Tree</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/data-structure/log-structured-merge-tree/" class="">LSM Tree</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/data-structure/skip-list/" class="">Skip List</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/data-structure/sorted-string-table/" class="">SSTable</a>
  

        </li>
      
    
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Database System</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/database-system/leveldb/" class="">LevelDB</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Distributed System</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/distributed-system/basic-theory-of-distributed-system/" class="">分布式系统基本理论</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/distributed-system/consensus-algorithm/" class="">分布式共识算法</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/distributed-system/distributed-transaction/" class="">分布式事务处理</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Best Papers</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-7dce83169aa3649ea8a7c376ae50d74f" class="toggle"  />
    <label for="section-7dce83169aa3649ea8a7c376ae50d74f" class="flex justify-between">
      <a role="button" class="">MIT 6.830</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/lab-report/CMU-15-445/lab1/" class="">Lab 1</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9e884a9db82bd737b80df1ed8a3a5b7a" class="toggle" checked />
    <label for="section-9e884a9db82bd737b80df1ed8a3a5b7a" class="flex justify-between">
      <a role="button" class="">MIT 6.830</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/lab-report/MIT-6.830/lab1/" class=" active">Lab 1</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Best Papers</span>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var menu=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Lab 1</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#exercise-1">Exercise 1</a>
      <ul>
        <li><a href="#tupledescjava">TupleDesc.java</a></li>
        <li><a href="#tuplejava">Tuple.java</a></li>
      </ul>
    </li>
    <li><a href="#exercise-2">Exercise 2</a>
      <ul>
        <li><a href="#catalogjava">Catalog.java</a></li>
      </ul>
    </li>
    <li><a href="#exercise-3">Exercise 3</a></li>
    <li><a href="#exercise-4">Exercise 4</a>
      <ul>
        <li><a href="#heappageidjava">HeapPageId.java</a></li>
        <li><a href="#recordidjava">RecordId.java</a></li>
        <li><a href="#heappagejava">HeapPage.java</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="lab-1">Lab 1</h1>
<h2 id="exercise-1">Exercise 1</h2>
<p>Exercise 1 需要我们完成以下文件的代码：</p>
<ul>
<li>src/java/simpledb/storage/TupleDesc.java</li>
<li>src/java/simpledb/storage/Tuple.java</li>
</ul>
<p><code>User</code> 表如下所示：</p>
<pre><code>id(INT) name(STRING) age(INT)
1       &quot;张三&quot;        12
2       &quot;李四&quot;        22
3       &quot;王二&quot;        54
</code></pre><p><code>Tuple.java</code> 表示表中的某一行数据，如：User(1, &ldquo;张三&rdquo;, 12), User(2, &ldquo;李四&rdquo;, 22)</p>
<p><code>TupleDesc.java</code> 表示表中字段的类型和名称，如：User{id(INT), name(STRING), age(INT)}</p>
<h3 id="tupledescjava">TupleDesc.java</h3>
<p><code>TupleDesc.java</code> 中的静态内部类 <code>TDItem</code> 用于表示某字段的类型（<code>Type fieldType</code>）和名称（<code>String fieldName</code>）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TDItem</span> <span style="color:#66d9ef">implements</span> Serializable <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> serialVersionUID <span style="color:#f92672">=</span> 1L<span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * The type of the field
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> Type fieldType<span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * The name of the field
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> String fieldName<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">TDItem</span><span style="color:#f92672">(</span>Type t<span style="color:#f92672">,</span> String n<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fieldName</span> <span style="color:#f92672">=</span> n<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fieldType</span> <span style="color:#f92672">=</span> t<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">toString</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> fieldName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;(&#34;</span> <span style="color:#f92672">+</span> fieldType <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;)&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>一个表可能有多个字段，我们可以采用 <code>TDItem[]</code> 直接表示表中所有字段的类型和名称。</p>
<p><code>TupleDesc</code> 一共提供了两个构造函数：</p>
<ol>
<li>指定字段类型和名称：<code>TupleDesc(Type[] typeAr, String[] fieldAr)</code></li>
<li>仅指定字段类型，设为匿名名称：<code>TupleDesc(Type[] typeAr)</code></li>
</ol>
<p>具体构造函数的实现如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 匿名字段名称
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String UNNAMED <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UNNAMED_FIELD_NAME&#34;</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 提供类型和名称
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">TupleDesc</span><span style="color:#f92672">(</span>Type<span style="color:#f92672">[]</span> typeAr<span style="color:#f92672">,</span> String<span style="color:#f92672">[]</span> fieldAr<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 一共有 n 列
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> typeAr<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>
    tdItems <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TDItem<span style="color:#f92672">[</span>n<span style="color:#f92672">];</span>

    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> n<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 字段名可能为空，设为匿名
</span><span style="color:#75715e"></span>        String fieldName <span style="color:#f92672">=</span> fieldAr <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> UNNAMED <span style="color:#f92672">:</span> fieldAr<span style="color:#f92672">[</span>i<span style="color:#f92672">];</span>
        tdItems<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TDItem<span style="color:#f92672">(</span>typeAr<span style="color:#f92672">[</span>i<span style="color:#f92672">],</span> fieldName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// 仅提供类型，名称设为匿名
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">TupleDesc</span><span style="color:#f92672">(</span>Type<span style="color:#f92672">[]</span> typeAr<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span>typeAr<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>可以直接根据 <code>TDItem[]</code> 数组的长度直接获取字段长度。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">numFields</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> tdItems<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>获取第 i 个字段的类型/名称，如果不存在直接抛出 <code>NoSuchElementException</code> 异常。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getFieldName</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> NoSuchElementException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span> i <span style="color:#f92672">&gt;=</span> tdItems<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NoSuchElementException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Index(&#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) out of bound.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> tdItems<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">fieldName</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> Type <span style="color:#a6e22e">getFieldType</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> NoSuchElementException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span> i <span style="color:#f92672">&gt;=</span> tdItems<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NoSuchElementException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Index(&#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) out of bound.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> tdItems<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">fieldType</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>通过名称获取字段的索引位置，直接遍历一遍找到字段名相同的即可。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fieldNameToIndex</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> NoSuchElementException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> tdItems<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> n<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
        String fieldName <span style="color:#f92672">=</span> tdItems<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">fieldName</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>fieldName<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>name<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> i<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NoSuchElementException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;FieldName(&#34;</span> <span style="color:#f92672">+</span> name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) is not exist.&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>获取字段类型的大小，直接遍历累加所有字段类型大小。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getSize</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">int</span> size <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>TDItem item <span style="color:#f92672">:</span> tdItems<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 累加每列类型的大小
</span><span style="color:#75715e"></span>        size <span style="color:#f92672">+=</span> item<span style="color:#f92672">.</span><span style="color:#a6e22e">fieldType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getLen</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> size<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>合并两个 <code>TupleDesc</code> 为一个 <code>TupleDesc</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> TupleDesc <span style="color:#a6e22e">merge</span><span style="color:#f92672">(</span>TupleDesc td1<span style="color:#f92672">,</span> TupleDesc td2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">int</span> n1 <span style="color:#f92672">=</span> td1<span style="color:#f92672">.</span><span style="color:#a6e22e">numFields</span><span style="color:#f92672">(),</span> n2 <span style="color:#f92672">=</span> td2<span style="color:#f92672">.</span><span style="color:#a6e22e">numFields</span><span style="color:#f92672">(),</span> n <span style="color:#f92672">=</span> n1 <span style="color:#f92672">+</span> n2<span style="color:#f92672">;</span>

    Type<span style="color:#f92672">[]</span> typeAr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Type<span style="color:#f92672">[</span>n<span style="color:#f92672">];</span>
    String<span style="color:#f92672">[]</span> fieldAr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[</span>n<span style="color:#f92672">];</span>

    <span style="color:#66d9ef">int</span> idx <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> n1<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
        typeAr<span style="color:#f92672">[</span>idx<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> td1<span style="color:#f92672">.</span><span style="color:#a6e22e">getFieldType</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
        fieldAr<span style="color:#f92672">[</span>idx<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> td1<span style="color:#f92672">.</span><span style="color:#a6e22e">getFieldName</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
        idx<span style="color:#f92672">++;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> n2<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
        typeAr<span style="color:#f92672">[</span>idx<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> td2<span style="color:#f92672">.</span><span style="color:#a6e22e">getFieldType</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
        fieldAr<span style="color:#f92672">[</span>idx<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> td2<span style="color:#f92672">.</span><span style="color:#a6e22e">getFieldName</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
        idx<span style="color:#f92672">++;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> TupleDesc<span style="color:#f92672">(</span>typeAr<span style="color:#f92672">,</span> fieldAr<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>equals()</code>, <code>hashCode()</code>, <code>toString()</code> 方法如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>Object o<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span> <span style="color:#f92672">==</span> o<span style="color:#f92672">)</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>o <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> getClass<span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> o<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">())</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    TupleDesc tupleDesc <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>TupleDesc<span style="color:#f92672">)</span> o<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">return</span> Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>tdItems<span style="color:#f92672">,</span> tupleDesc<span style="color:#f92672">.</span><span style="color:#a6e22e">tdItems</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">hashCode</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">hashCode</span><span style="color:#f92672">(</span>tdItems<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">toString</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    StringBuilder sb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>TDItem item <span style="color:#f92672">:</span> tdItems<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>item<span style="color:#f92672">.</span><span style="color:#a6e22e">fieldType</span><span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;(&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>item<span style="color:#f92672">.</span><span style="color:#a6e22e">fieldName</span><span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;)&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> sb<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="tuplejava">Tuple.java</h3>
<p><code>Tuple.java</code> 类用于保存某一行的所有值，设置 <code>Field[]</code> 数组来保存具体的值。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 每个 Tuple 都包含一个 TupleDesc 引用
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> TupleDesc td<span style="color:#f92672">;</span>

<span style="color:#75715e">// 用于保存一行的所有值
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Field<span style="color:#f92672">[]</span> fields<span style="color:#f92672">;</span>

<span style="color:#75715e">// 表示 Tuple 在磁盘中的位置，会发生改变
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> RecordId rid<span style="color:#f92672">;</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> serialVersionUID <span style="color:#f92672">=</span> 1L<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Tuple</span><span style="color:#f92672">(</span>TupleDesc td<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">td</span> <span style="color:#f92672">=</span> td<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fields</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Field<span style="color:#f92672">[</span>td<span style="color:#f92672">.</span><span style="color:#a6e22e">numFields</span><span style="color:#f92672">()];</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>数据库通过以下两个方法修改和获取某一行第 i 个字段的值。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setField</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">,</span> Field f<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span> i <span style="color:#f92672">&gt;=</span> td<span style="color:#f92672">.</span><span style="color:#a6e22e">numFields</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Index(&#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) out of bound.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    fields<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> f<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> Field <span style="color:#a6e22e">getField</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">||</span> i <span style="color:#f92672">&gt;=</span> td<span style="color:#f92672">.</span><span style="color:#a6e22e">numFields</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Index(&#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) out of bound.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> fields<span style="color:#f92672">[</span>i<span style="color:#f92672">];</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>toString()</code>, <code>fields()</code> 方法如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">toString</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    StringBuilder sb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Field field <span style="color:#f92672">:</span> fields<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>field<span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;\t&#39;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// remove last \t
</span><span style="color:#75715e"></span>    sb<span style="color:#f92672">.</span><span style="color:#a6e22e">setLength</span><span style="color:#f92672">(</span>sb<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> sb<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> Iterator<span style="color:#f92672">&lt;</span>Field<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">fields</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">stream</span><span style="color:#f92672">(</span>fields<span style="color:#f92672">).</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="exercise-2">Exercise 2</h2>
<p>Exercise 2 需要我们完成以下文件的代码：</p>
<ul>
<li>src/java/simpledb/common/Catalog.java</li>
</ul>
<p>Catalog 用于存储数据库的源信息（meta-data），如：数据库中的所有表信息、索引和模式等。
可以通过 <code>Database.getCatalog()</code> 获取到全局的单例 Catalog 实例。</p>
<h3 id="catalogjava">Catalog.java</h3>
<p>通过新建一个静态内部类 <code>Table</code> 用于保存表信息，当前数据库中的所有表既可以通过 <code>List&lt;Table&gt;</code> 保存。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Table</span> <span style="color:#f92672">{</span>
    DbFile file<span style="color:#f92672">;</span>
    String name<span style="color:#f92672">;</span>
    String pkeyField<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Table</span><span style="color:#f92672">(</span>DbFile file<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String pkeyField<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">file</span> <span style="color:#f92672">=</span> file<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> name<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pkeyField</span> <span style="color:#f92672">=</span> pkeyField<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>Catalog.java</code> 构造器如下，仅需要初始化用于保存表的 <code>List</code> 即可。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Catalog</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    tables <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>当添加新的表时，表名或者 id 可能重复，我们需要用新的表替换掉旧的表。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addTable</span><span style="color:#f92672">(</span>DbFile file<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> String pkeyField<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    tables<span style="color:#f92672">.</span><span style="color:#a6e22e">removeIf</span><span style="color:#f92672">(</span>e <span style="color:#f92672">-&gt;</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">name</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>name<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> file<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">());</span>
    tables<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Table<span style="color:#f92672">(</span>file<span style="color:#f92672">,</span> name<span style="color:#f92672">,</span> pkeyField<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>其他功能实现比较简单，仅需遍历查找到具体的值即可，可以通过 <code>Map</code> 缓存表名或 id 加快查找的速度。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getTableId</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> NoSuchElementException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Table table <span style="color:#f92672">:</span> tables<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>table<span style="color:#f92672">.</span><span style="color:#a6e22e">name</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>name<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> table<span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NoSuchElementException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Name(&#34;</span> <span style="color:#f92672">+</span> name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) is not exist.&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> TupleDesc <span style="color:#a6e22e">getTupleDesc</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> tableid<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> NoSuchElementException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> getDatabaseFile<span style="color:#f92672">(</span>tableid<span style="color:#f92672">).</span><span style="color:#a6e22e">getTupleDesc</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> DbFile <span style="color:#a6e22e">getDatabaseFile</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> tableid<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> NoSuchElementException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Table table <span style="color:#f92672">:</span> tables<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>table<span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> tableid<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> table<span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NoSuchElementException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tableid(&#34;</span> <span style="color:#f92672">+</span> tableid <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) is not exist.&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getPrimaryKey</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> tableid<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Table table <span style="color:#f92672">:</span> tables<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>table<span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> tableid<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> table<span style="color:#f92672">.</span><span style="color:#a6e22e">pkeyField</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NoSuchElementException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tableid(&#34;</span> <span style="color:#f92672">+</span> tableid <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) is not exist.&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> Iterator<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">tableIdIterator</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> tables<span style="color:#f92672">.</span><span style="color:#a6e22e">stream</span><span style="color:#f92672">().</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>e <span style="color:#f92672">-&gt;</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getTableName</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Table table <span style="color:#f92672">:</span> tables<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>table<span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> table<span style="color:#f92672">.</span><span style="color:#a6e22e">name</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NoSuchElementException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id(&#34;</span> <span style="color:#f92672">+</span> id <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;) is not exist.&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">clear</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    tables<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="exercise-3">Exercise 3</h2>
<p>Exercise 3 需要我们完成以下文件的代码：</p>
<ul>
<li>src/java/simpledb/storage/BufferPool.java</li>
</ul>
<p>BufferPool 是对数据库中 Page 的缓存，数据库对文件中 Page 的所有读、写操作都会经过 BufferPool 获取 Page。</p>
<p>LRU 的具体实现可以参考：
  <a href="https://leetcode.cn/problems/lru-cache/">LRU 缓存</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> simpledb.storage<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.util.HashMap<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LRUCache</span><span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> V<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Node</span> <span style="color:#f92672">{</span>
        K key<span style="color:#f92672">;</span>
        V val<span style="color:#f92672">;</span>
        Node prev<span style="color:#f92672">,</span> next<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Node</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Node</span><span style="color:#f92672">(</span>K key<span style="color:#f92672">,</span> V val<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> key<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> val<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Node head<span style="color:#f92672">,</span> tail<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> HashMap<span style="color:#f92672">&lt;</span>K<span style="color:#f92672">,</span> Node<span style="color:#f92672">&gt;</span> cache<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> maxSize<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">LRUCache</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> maxSize<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">maxSize</span> <span style="color:#f92672">=</span> maxSize<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cache</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;(</span>maxSize<span style="color:#f92672">);</span>
        head <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Node<span style="color:#f92672">();</span>
        tail <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Node<span style="color:#f92672">();</span>
        head<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> tail<span style="color:#f92672">;</span>
        tail<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> head<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
        node<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> Node <span style="color:#a6e22e">removeTail</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        Node node <span style="color:#f92672">=</span> tail<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">!=</span> head<span style="color:#f92672">)</span>
            remove<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> node<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">insertToHead</span><span style="color:#f92672">(</span>Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        head<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
        node<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> head<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">;</span>
        node<span style="color:#f92672">.</span><span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> head<span style="color:#f92672">;</span>
        head<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> node<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">moveToHead</span><span style="color:#f92672">(</span>Node node<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        remove<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
        insertToHead<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> V <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>K k<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Node node <span style="color:#f92672">=</span> cache<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>k<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        moveToHead<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> node<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>K k<span style="color:#f92672">,</span> V v<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Node node <span style="color:#f92672">=</span> cache<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>k<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>node <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            node<span style="color:#f92672">.</span><span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> v<span style="color:#f92672">;</span>
            moveToHead<span style="color:#f92672">(</span>node<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cache<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> maxSize<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Node removedNode <span style="color:#f92672">=</span> removeTail<span style="color:#f92672">();</span>
                cache<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>removedNode<span style="color:#f92672">.</span><span style="color:#a6e22e">key</span><span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
            Node newNode <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Node<span style="color:#f92672">(</span>k<span style="color:#f92672">,</span> v<span style="color:#f92672">);</span>
            cache<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>k<span style="color:#f92672">,</span> newNode<span style="color:#f92672">);</span>
            insertToHead<span style="color:#f92672">(</span>newNode<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p><code>BufferPool.java</code> 类的构造器如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> numPages<span style="color:#f92672">;</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> LRUCache<span style="color:#f92672">&lt;</span>PageId<span style="color:#f92672">,</span> Page<span style="color:#f92672">&gt;</span> cache<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">BufferPool</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> numPages<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">numPages</span> <span style="color:#f92672">=</span> numPages<span style="color:#f92672">;</span>
    cache <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LRUCache<span style="color:#f92672">&lt;&gt;(</span>numPages<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Exercise 3 仅需要我们初步实现 <code>getPage</code> 方法，简单实现如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> Page <span style="color:#a6e22e">getPage</span><span style="color:#f92672">(</span>TransactionId tid<span style="color:#f92672">,</span> PageId pid<span style="color:#f92672">,</span> Permissions perm<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">throws</span> TransactionAbortedException<span style="color:#f92672">,</span> DbException <span style="color:#f92672">{</span>
    Page page <span style="color:#f92672">=</span> cache<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>pid<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>page <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        page <span style="color:#f92672">=</span> Database<span style="color:#f92672">.</span><span style="color:#a6e22e">getCatalog</span><span style="color:#f92672">().</span>
                getDatabaseFile<span style="color:#f92672">(</span>pid<span style="color:#f92672">.</span><span style="color:#a6e22e">getTableId</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">readPage</span><span style="color:#f92672">(</span>pid<span style="color:#f92672">);</span>
        cache<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>pid<span style="color:#f92672">,</span> page<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> page<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="exercise-4">Exercise 4</h2>
<p>Exercise 4 需要我们完成以下文件的代码：</p>
<ul>
<li>src/java/simpledb/storage/HeapPageId.java</li>
<li>src/java/simpledb/storage/RecordId.java</li>
<li>src/java/simpledb/storage/HeapPage.java</li>
</ul>
<h3 id="heappageidjava">HeapPageId.java</h3>
<p><code>HeapPageId.java</code> 用于唯一标识一个 <code>Page</code>，
通过所在表的 id（<code>tableId</code>）和 Page Number（<code>pgNo</code>）即可唯一确定一个 Page 文件。</p>
<h3 id="recordidjava">RecordId.java</h3>
<p><code>RecordId.java</code> 用于唯一标识一个 <code>Tuple</code>，
通过所在 <code>Page</code> 的 id（<code>pid</code>）和 Tuple Number（<code>tupleno</code>）即可唯一确定一个 Tuple 。</p>
<h3 id="heappagejava">HeapPage.java</h3>
<p><code>HeapPage.java</code> 用于具体存储 <code>Tuple</code> 到文件中，
<code>HeapPage</code> 文件根据 <code>Tuple</code> 大小被划分为多个 slot，一个 slot 可以存储一个 <code>Tuple</code> 。
我们需要使用位图记录哪些 slot 是正在使用或未使用。原代码中已经提供 <code>byte[] header</code> 来供我们实现位图功能。</p>
<p>计算一个 Page 可以存放多少个 Tuple，计算公式在构造器的注释中给出。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getNumTuples</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">floor</span><span style="color:#f92672">((</span>BufferPool<span style="color:#f92672">.</span><span style="color:#a6e22e">getPageSize</span><span style="color:#f92672">()</span> <span style="color:#f92672">*</span> 8<span style="color:#f92672">)</span> <span style="color:#f92672">/</span> <span style="color:#f92672">(</span>td<span style="color:#f92672">.</span><span style="color:#a6e22e">getSize</span><span style="color:#f92672">()</span> <span style="color:#f92672">*</span> 8 <span style="color:#f92672">+</span> 1<span style="color:#f92672">));</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>计算需要多大长度的 byte 数组用于保存位图。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getHeaderSize</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">ceil</span><span style="color:#f92672">(</span>getNumTuples<span style="color:#f92672">()</span> <span style="color:#f92672">/</span> 8<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>计算该 Page 有多少个空的 slot，只需遍历所有的 slot，查看是否正在使用。</p>
<p>优化：可以额外使用一个变量记录已经使用的 slot 数量，则 <code>未使用的 slot 数量 = slot 总数 - 正在使用的 slot 数量</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getNumEmptySlots</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 不可以直接遍历 header，因为 numSlots &lt;= header.length * 8
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 可能会遍历到永远不会用到的位置
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> cnt <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> numSlots<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isSlotUsed<span style="color:#f92672">(</span>i<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            cnt<span style="color:#f92672">++;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> cnt<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>通过位图计算某个 slot 是否正在被使用中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isSlotUsed</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// i / 8 确定位于 header 的索引位置 n
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// i % 8 确定位于 header[n] 的第几个二进制位
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">((</span>header<span style="color:#f92672">[</span>i <span style="color:#f92672">/</span> 8<span style="color:#f92672">]</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">%</span> 8<span style="color:#f92672">))</span> <span style="color:#f92672">&amp;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 1<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>通过迭代器迭代当前 Page 中的 Tuple，此处需要去除未使用的 slot。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> Iterator<span style="color:#f92672">&lt;</span>Tuple<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">iterator</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Iterator<span style="color:#f92672">&lt;&gt;()</span> <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> idx <span style="color:#f92672">=</span> 0<span style="color:#f92672">,</span> cnt <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

        <span style="color:#75715e">// 已经使用的 slot 数量
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> usedSlotNum <span style="color:#f92672">=</span> getNumTuples<span style="color:#f92672">()</span> <span style="color:#f92672">-</span> getNumEmptySlots<span style="color:#f92672">();</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasNext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> cnt <span style="color:#f92672">&lt;</span> usedSlotNum<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> Tuple <span style="color:#a6e22e">next</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>isSlotUsed<span style="color:#f92672">(</span>idx<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                idx<span style="color:#f92672">++;</span>
            <span style="color:#f92672">}</span>
            cnt<span style="color:#f92672">++;</span>
            <span style="color:#66d9ef">return</span> tuples<span style="color:#f92672">[</span>idx<span style="color:#f92672">++];</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">};</span>
<span style="color:#f92672">}</span>
</code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function select(element){const selection=window.getSelection();const range=document.createRange();range.selectNodeContents(element);selection.removeAllRanges();selection.addRange(range);}
document.querySelectorAll("pre code").forEach(code=>{code.addEventListener("click",function(event){select(code.parentElement);if(navigator.clipboard){navigator.clipboard.writeText(code.parentElement.textContent);}});});})();</script>


 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#exercise-1">Exercise 1</a>
      <ul>
        <li><a href="#tupledescjava">TupleDesc.java</a></li>
        <li><a href="#tuplejava">Tuple.java</a></li>
      </ul>
    </li>
    <li><a href="#exercise-2">Exercise 2</a>
      <ul>
        <li><a href="#catalogjava">Catalog.java</a></li>
      </ul>
    </li>
    <li><a href="#exercise-3">Exercise 3</a></li>
    <li><a href="#exercise-4">Exercise 4</a>
      <ul>
        <li><a href="#heappageidjava">HeapPageId.java</a></li>
        <li><a href="#recordidjava">RecordId.java</a></li>
        <li><a href="#heappagejava">HeapPage.java</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












