<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  boltdb 存储
  #


  bolt.Open()
  #


  bolt.Open() 是使用数据库的第一个方法，也是最重要的方法之一。该代码的作用是初始化一个 DB 对象。

  参数设置
  #

首先会创建一个 DB 对象，opened 用于指示数据库是否已成功打开。。
var db = &amp;DB{opened: true}
对参数进行一些初始化设置。
// Set default options if no options are provided.
if options == nil {
	options = DefaultOptions
}
db.NoGrowSync = options.NoGrowSync
db.MmapFlags = options.MmapFlags
// Set default values for later DB operations.
db.MaxBatchSize = DefaultMaxBatchSize
db.MaxBatchDelay = DefaultMaxBatchDelay
db.AllocSize = DefaultAllocSize

  OpenFile
  #

使用 os.OpenFile() 方法打开传入的数据库文件路径，不存在则创建。
flag := os.O_RDWR
if options.ReadOnly {
	flag = os.O_RDONLY
	db.readOnly = true
}

// Open data file and separate sync handler for metadata writes.
db.path = path
var err error
if db.file, err = os.OpenFile(db.path, flag|os.O_CREATE, mode); err != nil {
	_ = db.close()
	return nil, err
}

  flock
  #

boltdb 同一时刻只允许一个进程对数据库进行读写操作，因此使用 
  flock 对数据库文件进行加锁。"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://ileonli.github.io/docs/boltdb/storage/"><meta property="og:site_name" content="Leon' Blog"><meta property="og:title" content="boltdb 存储"><meta property="og:description" content=" boltdb 存储 # bolt.Open() # bolt.Open() 是使用数据库的第一个方法，也是最重要的方法之一。该代码的作用是初始化一个 DB 对象。
参数设置 # 首先会创建一个 DB 对象，opened 用于指示数据库是否已成功打开。。
var db = &amp;DB{opened: true} 对参数进行一些初始化设置。
// Set default options if no options are provided. if options == nil { options = DefaultOptions } db.NoGrowSync = options.NoGrowSync db.MmapFlags = options.MmapFlags // Set default values for later DB operations. db.MaxBatchSize = DefaultMaxBatchSize db.MaxBatchDelay = DefaultMaxBatchDelay db.AllocSize = DefaultAllocSize OpenFile # 使用 os.OpenFile() 方法打开传入的数据库文件路径，不存在则创建。
flag := os.O_RDWR if options.ReadOnly { flag = os.O_RDONLY db.readOnly = true } // Open data file and separate sync handler for metadata writes. db.path = path var err error if db.file, err = os.OpenFile(db.path, flag|os.O_CREATE, mode); err != nil { _ = db.close() return nil, err } flock # boltdb 同一时刻只允许一个进程对数据库进行读写操作，因此使用 flock 对数据库文件进行加锁。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-08-23T22:42:38+08:00"><title>boltdb 存储 | Leon' Blog</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.min.c4648f90e7f239143d6b1f74326dc2ce1794185b23b8cbbf3f813cfdf5d576ca.css integrity="sha256-xGSPkOfyORQ9ax90Mm3CzheUGFsjuMu/P4E8/fXVdso=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.0cb83f41dff236af4990cd82c7758a72fd6ff0c9ef6390c4a5626f97158e477d.js integrity="sha256-DLg/Qd/yNq9JkM2Cx3WKcv1v8MnvY5DEpWJvlxWOR30=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-EL04QEY330"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EL04QEY330")}</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Leon' Blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-dfc62bc51fd10e15afc9a11c29a21438 class=toggle>
<label for=section-dfc62bc51fd10e15afc9a11c29a21438 class="flex justify-between"><a role=button>Java</a></label><ul><li><a href=/docs/Java/Agent/>Agent</a></li><li><a href=/docs/Java/Cleaner/>Cleaner 类</a></li><li><a href=/docs/Java/JDBC/>JDBC</a></li><li><a href=/docs/Java/MethodHandles/>MethodHandles</a></li><li><a href=/docs/Java/DynamicProxy/>动态代理</a></li></ul></li><li><input type=checkbox id=section-068f5864eab5429f74d44490ac7dda4f class=toggle checked>
<label for=section-068f5864eab5429f74d44490ac7dda4f class="flex justify-between"><a role=button>boltdb</a></label><ul><li><a href=/docs/boltdb/introduction/>boltdb 介绍</a></li><li><a href=/docs/boltdb/node/>boltdb node</a></li><li><a href=/docs/boltdb/transaction/>boltdb 事务</a></li><li><a href=/docs/boltdb/bucket/>boltdb 介绍</a></li><li><a href=/docs/boltdb/storage/ class=active>boltdb 存储</a></li><li><a href=/docs/boltdb/page/>boltdb 页结构</a></li></ul></li><li><input type=checkbox id=section-6a1b1f139889384d884552bee56583cd class=toggle>
<label for=section-6a1b1f139889384d884552bee56583cd class="flex justify-between"><a role=button>15-445</a></label><ul><li><a href=/docs/15-445/storage/>Database Storage</a></li></ul></li><li><input type=checkbox id=section-3dfb06d56069fc22bb179a4001826101 class=toggle>
<label for=section-3dfb06d56069fc22bb179a4001826101 class="flex justify-between"><a role=button>Data Structure</a></label><ul><li><a href=/docs/DataStructure/skiplist/>Skip List</a></li></ul></li><li><input type=checkbox id=section-dd174040a908659982d53d695ff59f6c class=toggle>
<label for=section-dd174040a908659982d53d695ff59f6c class="flex justify-between"><a role=button>JVM</a></label><ul><li><a href=/docs/JVM/AsmTools/>AsmTools</a></li><li><a href=/docs/JVM/loading-linking-initializing/>JVM 加载-链接-初始化</a></li><li><input type=checkbox id=section-8116e10cba9ea1a7d22332ccf696967c class=toggle>
<label for=section-8116e10cba9ea1a7d22332ccf696967c class="flex justify-between"><a role=button>字节码</a></label><ul><li><a href=/docs/JVM/ByteCode/ClassFile/>Class 文件结构</a></li><li><a href=/docs/JVM/ByteCode/constant_pool/>常量池</a></li></ul></li></ul></li><li><input type=checkbox id=section-322adad93406759f98a33491e2ecc8af class=toggle>
<label for=section-322adad93406759f98a33491e2ecc8af class="flex justify-between"><a role=button>Linux 网络编程</a></label><ul><li><a href=/docs/system-programming/network-byte-order/>网络字节序</a></li><li><a href=/docs/system-programming/address-families/>网络地址族</a></li><li><a href=/docs/system-programming/block-and-nonblock-io/>（非）阻塞 I/O</a></li><li><a href=/docs/system-programming/multiplexing/>I/O 多路复用</a></li><li><a href=/docs/system-programming/reactor-pattern/>Reactor 模型</a></li><li><a href=/docs/system-programming/sockets/>套接字（socket）</a></li><li><a href=/docs/system-programming/echo-server/>echo 服务器</a></li></ul></li><li><input type=checkbox id=section-bcab9cce661800a90eaf0ba45525a392 class=toggle>
<label for=section-bcab9cce661800a90eaf0ba45525a392 class="flex justify-between"><a role=button>MapDB</a></label><ul><li><a href=/docs/MapDB/BTree/>BTree</a></li></ul></li><li><input type=checkbox id=section-be784f006af4b056e801791bd4131884 class=toggle>
<label for=section-be784f006af4b056e801791bd4131884 class="flex justify-between"><a role=button>MyBatis</a></label><ul><li><a href=/docs/MyBatis/SqlSession/>SqlSession</a></li><li><a href=/docs/MyBatis/Mapper/>Mapper</a></li><li><a href=/docs/MyBatis/ResultSetHandler/>ResultSetHandler</a></li><li><a href=/docs/MyBatis/StatementHandler/>StatementHandler</a></li><li><a href=/docs/MyBatis/Executor/>Executor</a></li><li><a href=/docs/MyBatis/Cache/>Cache</a></li></ul></li><li><input type=checkbox id=section-53f18a28714f2e0ba277c362c8e2fe7d class=toggle>
<label for=section-53f18a28714f2e0ba277c362c8e2fe7d class="flex justify-between"><a role=button>MySQL</a></label><ul></ul></li><li><input type=checkbox id=section-8e8ae3b760618e1158c1946d2d023ca5 class=toggle>
<label for=section-8e8ae3b760618e1158c1946d2d023ca5 class="flex justify-between"><a role=button>Netty</a></label><ul><li><a href=/docs/Netty/ByteBuf/>ByteBuf</a></li><li><a href=/docs/Netty/EventLoop/>EventLoop</a></li><li><a href=/docs/Netty/EventLoopGroup/>EventLoopGroup</a></li><li><a href=/docs/Netty/Channel/>Channel</a></li><li><a href=/docs/Netty/ChannelHandler/>ChannelHandler</a></li><li><a href=/docs/Netty/encoder-and-decoder/>编码器和解码器</a></li></ul></li><li><input type=checkbox id=section-bccb031e3769927ed8f05e90efe74959 class=toggle>
<label for=section-bccb031e3769927ed8f05e90efe74959 class="flex justify-between"><a role=button>Pro Git</a></label><ul><li><a href=/docs/ProGit/Git-%E5%9F%BA%E7%A1%80/>Git 基础</a></li><li><a href=/docs/ProGit/Git-%E5%88%86%E6%94%AF/>Git 分支</a></li></ul></li><li><span>计算机网络</span><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>boltdb 存储</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#boltdb-存储>boltdb 存储</a><ul><li><a href=#boltopen>bolt.Open()</a><ul><li><a href=#参数设置>参数设置</a></li><li><a href=#openfile>OpenFile</a></li><li><a href=#flock>flock</a></li><li><a href=#writeat>WriteAt</a></li><li><a href=#数据库文件>数据库文件</a></li><li><a href=#pagepool>pagePool</a></li><li><a href=#mmap>mmap</a></li></ul></li><li><a href=#dbinit>DB.init()</a><ul><li><a href=#pagesize>pageSize</a></li><li><a href=#pages>pages</a></li><li><a href=#为什么创建两个-meta>为什么创建两个 meta</a></li></ul></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=boltdb-存储>boltdb 存储
<a class=anchor href=#boltdb-%e5%ad%98%e5%82%a8>#</a></h1><h2 id=boltopen>bolt.Open()
<a class=anchor href=#boltopen>#</a></h2><p><a href=https://github.com/boltdb/bolt/blob/master/db.go#L150><code>bolt.Open()</code></a> 是使用数据库的第一个方法，也是最重要的方法之一。该代码的作用是初始化一个 <code>DB</code> 对象。</p><h3 id=参数设置>参数设置
<a class=anchor href=#%e5%8f%82%e6%95%b0%e8%ae%be%e7%bd%ae>#</a></h3><p>首先会创建一个 <code>DB</code> 对象，<code>opened</code> 用于指示数据库是否已成功打开。。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>db</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>DB</span>{<span style=color:#a6e22e>opened</span>: <span style=color:#66d9ef>true</span>}
</span></span></code></pre></div><p>对参数进行一些初始化设置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Set default options if no options are provided.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>options</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>options</span> = <span style=color:#a6e22e>DefaultOptions</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>NoGrowSync</span> = <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>NoGrowSync</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>MmapFlags</span> = <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>MmapFlags</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Set default values for later DB operations.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>MaxBatchSize</span> = <span style=color:#a6e22e>DefaultMaxBatchSize</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>MaxBatchDelay</span> = <span style=color:#a6e22e>DefaultMaxBatchDelay</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>AllocSize</span> = <span style=color:#a6e22e>DefaultAllocSize</span>
</span></span></code></pre></div><h3 id=openfile>OpenFile
<a class=anchor href=#openfile>#</a></h3><p>使用 <code>os.OpenFile()</code> 方法打开传入的数据库文件路径，不存在则创建。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#a6e22e>flag</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_RDWR</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>ReadOnly</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_RDONLY</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>readOnly</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Open data file and separate sync handler for metadata writes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>path</span> = <span style=color:#a6e22e>path</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>OpenFile</span>(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>flag</span>|<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>O_CREATE</span>, <span style=color:#a6e22e>mode</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>db</span>.close()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=flock>flock
<a class=anchor href=#flock>#</a></h3><p>boltdb 同一时刻只允许一个进程对数据库进行读写操作，因此使用
<a href=https%ef%bc%9a//man7.org/linux/man-pages/man2/flock.2.html><code>flock</code></a> 对数据库文件进行加锁。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Lock file so that other processes using boltdb in read-write mode cannot
</span></span></span><span style=display:flex><span><span style=color:#75715e>// use the database  at the same time. This would cause corruption since
</span></span></span><span style=display:flex><span><span style=color:#75715e>// the two processes would write meta pages and free pages separately.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// The database file is locked exclusively (only one process can grab the lock)
</span></span></span><span style=display:flex><span><span style=color:#75715e>// if !options.ReadOnly.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// The database file is locked using the shared lock (more than one process may
</span></span></span><span style=display:flex><span><span style=color:#75715e>// hold a lock at the same time) otherwise (options.ReadOnly is set).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flock</span>(<span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>mode</span>, !<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>readOnly</span>, <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Timeout</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>db</span>.close()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><p><code>flock</code> 它用于在文件描述符上获取建议性锁（advisory lock）。</p><blockquote><p>在一个文件上不能同时获取 <code>LOCK_SH</code> 和 <code>LOCK_EX</code> 锁。</p></blockquote><p>下面是对
<a href=https://github.com/boltdb/bolt/blob/master/bolt_unix.go#L14><code>flock</code></a> 代码进行详细解释：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>flock</span>(<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>, <span style=color:#a6e22e>mode</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>FileMode</span>, <span style=color:#a6e22e>exclusive</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#66d9ef>error</span>
</span></span></code></pre></div><ul><li><code>db *DB</code>：传入的 <code>DB</code> 是一个数据库对象。</li><li><code>mode os.FileMode</code>：代表文件的模式，通常与文件的权限设置相关。</li><li><code>exclusive bool</code>：这个布尔值指示是否要获取一个排他锁（exclusive lock）。如果为 <code>true</code>，表示获取排他锁，否则获取共享锁。</li><li><code>timeout time.Duration</code>：尝试获取锁的超时时间。</li></ul><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>t</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span><span style=color:#75715e>// If we&#39;re beyond our timeout then return an error.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// This can only occur after we&#39;ve attempted a flock once.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>IsZero</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>timeout</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>t</span>) &gt; <span style=color:#a6e22e>timeout</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ErrTimeout</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>var t time.Time</code>：初始化时间变量 <code>t</code>。</li><li><code>t.IsZero()</code>：判断时间 <code>t</code> 是否为零值。如果是零值，说明这是第一次尝试获取锁，此时会将 <code>t</code> 设置为当前时间。</li><li><code>timeout > 0 && time.Since(t) > timeout</code>：如果设置了超时时间且当前时间与初始时间的差值超过了超时时间，则返回超时错误 <code>ErrTimeout</code>。</li></ul><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#a6e22e>flag</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>LOCK_SH</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>exclusive</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>flag</span> = <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>LOCK_EX</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>syscall.LOCK_SH</code>：共享锁标志。</li><li><code>syscall.LOCK_EX</code>：排他锁标志。</li><li>根据 <code>exclusive</code> 参数，决定使用共享锁还是排他锁。</li></ul><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Flock</span>(int(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Fd</span>()), <span style=color:#a6e22e>flag</span>|<span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>LOCK_NB</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>EWOULDBLOCK</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>syscall.Flock(int(db.file.Fd()), flag|syscall.LOCK_NB)</code>：使用系统调用 <code>Flock</code> 尝试获取文件锁。<ul><li><code>int(db.file.Fd())</code>：获取文件描述符。</li><li><code>flag|syscall.LOCK_NB</code>：非阻塞地获取锁（<code>LOCK_NB</code>）。</li></ul></li><li><code>err == nil</code>：如果获取锁成功，返回 <code>nil</code>，表示操作成功。</li><li><code>err != syscall.EWOULDBLOCK</code>：如果出现其他错误（除了锁被占用），直接返回错误。</li></ul><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Wait for a bit and try again.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span></code></pre></div><ul><li>如果锁被占用（即 <code>err == syscall.EWOULDBLOCK</code>），则等待 50 毫秒后重试。</li></ul><h3 id=writeat>WriteAt
<a class=anchor href=#writeat>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Default values for test hooks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>ops</span>.<span style=color:#a6e22e>writeAt</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>WriteAt</span>
</span></span></code></pre></div><p>这行代码的作用是将文件对象的 <code>WriteAt</code> 方法赋值给 <code>db.ops.writeAt</code>，使得 <code>db.ops.writeAt</code> 可以作为文件写入操作的默认实现。如果有需要（例如在测试中），可以替换 <code>db.ops.writeAt</code> 为其它自定义函数。</p><h3 id=数据库文件>数据库文件
<a class=anchor href=#%e6%95%b0%e6%8d%ae%e5%ba%93%e6%96%87%e4%bb%b6>#</a></h3><p>这段代码负责在打开数据库文件时进行初始化工作，确保文件存在且正确设置了数据库的页大小。</p><ul><li>如果<strong>文件不存在或大小为零</strong>，代码将初始化一个新的数据库文件。</li><li>如果<strong>文件已经存在且包含数据</strong>，代码将读取文件中的元数据以确定页面大小。</li></ul><p>页大小对于数据库文件的正确读取和写入至关重要，任何与页面大小相关的错误都可能导致严重的问题。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Initialize the database if it doesn&#39;t exist.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>info</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Stat</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>Size</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Initialize new files with meta pages.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>init</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Read the first meta page to determine the page size.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buf</span> [<span style=color:#ae81ff>0x1000</span>]<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>ReadAt</span>(<span style=color:#a6e22e>buf</span>[:], <span style=color:#ae81ff>0</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageInBuffer</span>(<span style=color:#a6e22e>buf</span>[:], <span style=color:#ae81ff>0</span>).<span style=color:#a6e22e>meta</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>validate</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// If we can&#39;t read the page size, we can assume it&#39;s the same
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// as the OS -- since that&#39;s how the page size was chosen in the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// first place.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// If the first page is invalid and this OS uses a different
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// page size than what the database was created with then we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// are out of luck and cannot access the database.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageSize</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getpagesize</span>()
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageSize</span> = int(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pageSize</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><p>上边代码逻辑如下：</p><ol><li><p>检查文件状态：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>info</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Stat</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><code>db.file.Stat()</code> 方法用于获取文件的状态信息（<code>os.FileInfo</code>），包括文件的大小、修改时间等。</li><li>如果获取文件状态时发生错误（例如文件不存在），则返回错误 <code>err</code>。</li></ul></li><li><p>初始化新文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>Size</span>() <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Initialize new files with meta pages.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>init</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>如果文件大小为零，意味着文件是新创建的或为空。</li><li>调用 <code>db.init()</code> 方法来初始化新的数据库文件，通常会在文件中写入元数据页（meta pages）等必要信息。</li><li>如果初始化过程中发生错误，则返回该错误。</li></ul></li><li><p>读取现有文件的元数据页：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Read the first meta page to determine the page size.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buf</span> [<span style=color:#ae81ff>0x1000</span>]<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>ReadAt</span>(<span style=color:#a6e22e>buf</span>[:], <span style=color:#ae81ff>0</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageInBuffer</span>(<span style=color:#a6e22e>buf</span>[:], <span style=color:#ae81ff>0</span>).<span style=color:#a6e22e>meta</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>validate</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageSize</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getpagesize</span>()
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageSize</span> = int(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pageSize</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>如果文件已存在且大小大于零，意味着文件中可能已有数据。</li><li>使用 <code>db.file.ReadAt(buf[:], 0)</code> 读取文件的前 4KB（0x1000 字节）内容，包含了数据库的元数据页。</li><li><code>db.pageInBuffer(buf[:], 0).meta()</code> 提取了元数据页的内容，并使用 <code>m.validate()</code> 进行验证。</li></ul></li><li><p>确定页面大小：</p><ul><li>如果元数据页有效，<code>m.pageSize</code> 将指定数据库文件的页面大小，并将其设置为 <code>db.pageSize</code>。</li><li>如果元数据页无效（例如因为文件损坏或不兼容），则页面大小将默认设置为操作系统的页面大小 <code>os.Getpagesize()</code>。</li></ul></li></ol><h3 id=pagepool>pagePool
<a class=anchor href=#pagepool>#</a></h3><p>下边代码可以利用 <code>sync.Pool</code> 来管理页面对象的重用，从而减少内存分配的开销，提高程序的性能。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Initialize page pool.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pagePool</span> = <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Pool</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>New</span>: <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>interface</span>{} {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageSize</span>)
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=mmap>mmap
<a class=anchor href=#mmap>#</a></h3><p>下边代码将数据文件映射到内存中，在处理文件时可以直接访问内存中的数据，而不必反复进行磁盘读取。可提高读取文件的性能。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Memory map the data file.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>mmap</span>(<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>InitialMmapSize</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>db</span>.close()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=freelist>freelist
<a class=anchor href=#freelist>#</a></h4><p>整个过程的目的是将数据文件中存储的 <code>freelist</code> 信息读入内存中的 <code>freelist</code> 对象中，以便在后续的操作中可以方便地管理和维护空闲的数据块或页面。这有助于数据库的性能和空间管理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Read in the freelist.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>freelist</span> = <span style=color:#a6e22e>newFreelist</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>freelist</span>.<span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>page</span>(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>meta</span>().<span style=color:#a6e22e>freelist</span>))
</span></span></code></pre></div><h2 id=dbinit>DB.init()
<a class=anchor href=#dbinit>#</a></h2><p>当调用 <code>bolt.Open()</code> 打开的文件为空时，会调用 <code>db.init()</code> 对数据库文件进行一些初始化操作。</p><p>当我们使用下边的代码新建一个数据库。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bolt</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;db.db&#34;</span>, <span style=color:#ae81ff>0600</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Close</span>()
</span></span></code></pre></div><p>boltdb 提供了
<a href=https://github.com/boltdb/bolt/blob/master/cmd/bolt/main.go>main.go</a> 工具，对用于对数据库文件进行分析。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash><span style=display:flex><span>$ bolt pages db.db 
</span></span><span style=display:flex><span>ID       TYPE       ITEMS  OVRFLW
</span></span><span style=display:flex><span><span style=color:#f92672>========</span> <span style=color:#f92672>==========</span> <span style=color:#f92672>======</span> <span style=color:#f92672>======</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>        meta       <span style=color:#ae81ff>0</span>            
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>        meta       <span style=color:#ae81ff>0</span>            
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>        freelist   <span style=color:#ae81ff>0</span>            
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>        leaf       <span style=color:#ae81ff>0</span>            
</span></span></code></pre></div><p>可以看到，新初始化包含 4 个页，2 个 <code>meta</code>、1 个 <code>freelist</code> 和 1 个 <code>leaf</code> 页。</p><p>下边是对
<a href=https://github.com/boltdb/bolt/blob/master/db.go#L343><code>db.init()</code></a> 代码的解析：</p><h3 id=pagesize>pageSize
<a class=anchor href=#pagesize>#</a></h3><p>将页大小设置为操作系统的页大小。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Set the page size to the OS page size.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageSize</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getpagesize</span>()
</span></span></code></pre></div><h3 id=pages>pages
<a class=anchor href=#pages>#</a></h3><p>首先会创建 4 个页大小的 <code>[]byte</code>，用于容纳后续创建的页，分别是：2 个 <code>meta</code>、1 个 <code>freelist</code> 和 1 个 <code>leaf</code> 页。</p><p>通过循环创建两个 <code>meta</code> 页，并对其进行初始化。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Create two meta pages on a buffer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageSize</span><span style=color:#f92672>*</span><span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>2</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageInBuffer</span>(<span style=color:#a6e22e>buf</span>[:], <span style=color:#a6e22e>pgid</span>(<span style=color:#a6e22e>i</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>pgid</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>flags</span> = <span style=color:#a6e22e>metaPageFlag</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Initialize the meta page.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>meta</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>magic</span> = <span style=color:#a6e22e>magic</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>version</span> = <span style=color:#a6e22e>version</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pageSize</span> = uint32(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageSize</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>freelist</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>root</span> = <span style=color:#a6e22e>bucket</span>{<span style=color:#a6e22e>root</span>: <span style=color:#ae81ff>3</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pgid</span> = <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>txid</span> = <span style=color:#a6e22e>txid</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>checksum</span> = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>sum64</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>创建一个 <code>freelist</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Write an empty freelist at page 3.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageInBuffer</span>(<span style=color:#a6e22e>buf</span>[:], <span style=color:#a6e22e>pgid</span>(<span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>pgid</span>(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>flags</span> = <span style=color:#a6e22e>freelistPageFlag</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>count</span> = <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>创建一个 <code>leaf page</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Write an empty leaf page at page 4.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>p</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>pageInBuffer</span>(<span style=color:#a6e22e>buf</span>[:], <span style=color:#a6e22e>pgid</span>(<span style=color:#ae81ff>3</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>pgid</span>(<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>flags</span> = <span style=color:#a6e22e>leafPageFlag</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>count</span> = <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>将 <code>buf</code> 保存到磁盘中，完成数据库磁盘文件的初始化。</p><p>使用 <code>fdatasync</code> 可以确保将文件的内存缓冲区的内容同步到磁盘中，而不仅仅写入到操作系统的内存缓冲区。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// Write the buffer to our data file.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>ops</span>.<span style=color:#a6e22e>writeAt</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#ae81ff>0</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fdatasync</span>(<span style=color:#a6e22e>db</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=为什么创建两个-meta>为什么创建两个 meta
<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%88%9b%e5%bb%ba%e4%b8%a4%e4%b8%aa-meta>#</a></h3><p><code>meta</code> 是 boltdb 数据库最重要的信息，所有信息都保存在此结构中。如果此结构发生错误，则无法重新读取数据库信息。</p><p>事务在初始化时只会使用一个 <code>meta0</code> 或 <code>meta1</code>。例如：本次事务使用 <code>meta0</code>，如果事务提交后，<code>meta0</code> 写入一半时出错，调用 <code>validate()</code> 校验失败，则可以使用 <code>meta1</code> 恢复出数据库信息，而不至于全部丢失。</p><p>当发现一个新写入的 <code>meta</code> 出错时会使用另一个:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// meta retrieves the current meta page reference.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>meta</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>meta</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// We have to return the meta with the highest txid which doesn&#39;t fail
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// validation. Otherwise, we can cause errors when in fact the database is
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// in a consistent state. metaA is the one with the higher txid.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>metaA</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>meta0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>metaB</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>meta1</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>meta1</span>.<span style=color:#a6e22e>txid</span> &gt; <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>meta0</span>.<span style=color:#a6e22e>txid</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>metaA</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>meta1</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>metaB</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>meta0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Use higher meta page if valid. Otherwise fallback to previous, if valid.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>metaA</span>.<span style=color:#a6e22e>validate</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>metaA</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>metaB</span>.<span style=color:#a6e22e>validate</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>metaB</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This should never be reached, because both meta1 and meta0 were validated
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// on mmap() and we do fsync() on every write.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	panic(<span style=color:#e6db74>&#34;bolt.DB.meta(): invalid meta pages&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#boltdb-存储>boltdb 存储</a><ul><li><a href=#boltopen>bolt.Open()</a><ul><li><a href=#参数设置>参数设置</a></li><li><a href=#openfile>OpenFile</a></li><li><a href=#flock>flock</a></li><li><a href=#writeat>WriteAt</a></li><li><a href=#数据库文件>数据库文件</a></li><li><a href=#pagepool>pagePool</a></li><li><a href=#mmap>mmap</a></li></ul></li><li><a href=#dbinit>DB.init()</a><ul><li><a href=#pagesize>pageSize</a></li><li><a href=#pages>pages</a></li><li><a href=#为什么创建两个-meta>为什么创建两个 meta</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>