<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>MyBatis Mapper</title>
<link href=https://unpkg.com/@master/normal.css rel=stylesheet><script src=https://unpkg.com/@master/style@1.5.0></script><script src=https://unpkg.com/@master/styles@1.13.0></script><script src=https://unpkg.com/master-styles-group></script><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/syst/dist/SourceHanSerifCN/result.css><style>body{font-family:source han serif cn vf}</style></head><body class="bg:fade-84@dark font:fade-16@dark"><div class="d:flex flex:column@<=sm pt:60 px:24 jc:center gap:44 word-break:break-word"><div class="max-w:800 w:full box:content-box"><article class="box:border-box pt:32"><div class="_:where(a):hover{text-decoration-color:fade}
_:where(a){text-decoration:2;underline;fade-30;_text-decoration-color:fade-70@dark}
_:where(blockquote){bl:5;solid;fade-76/.1;_bl:5;solid;fade-34/.1@dark}
_:where(code){font:90%;_v:middle}
_:where(code:not(.highlight_*,pre_*)){p:2}
_:where(del){text-decoration:1;line-through;fade-68;_text-decoration-color:red-64@dark}
_:where(figcaption){text:14;_p:10;20;0;_width:fit;_mx:auto;_font:fade-56;_font:fade-57@dark}
_:where(h1,h2,h3,h4,h5,h6){mt:1em}
_:where(h1){font:40;_font:extrabold}
_:where(h1){my:1em}
_:where(h2){font:32}
_:where(h3){font:24}
_:where(h4){font:20}
_:where(h5){font:16}
_:where(h6){font:14}
_:where(li)::marker{font:fade-44;_font:fade-68@dark}
_:where(li){pl:.375em}
_:where(mark){text-decoration:1;underline;#fce016;_bg:transparent;_text-decoration-color:rgb(252;224;22/.5)@dark}
_:where(p,li){font:fade-76;_font:16;_line-height:1.65;_font:fade-34@dark}
_:where(p,pre,blockquote,figure,ul,ol,table){my:1em}
>:first-child{mt:0!}
_:where(pre){p:20;_r:8;_overflow:auto}
_:where(pre,code:not(.highlight_*)){bg:fade-2;_bg:fade-92!@dark}
_:where(strong,b,a,code:not(.highlight_*),mark,del){font:fade-92;_font:fade-12@dark}
_:where(table){width:full;_border-spacing:0}
_:where(td){v:baseline}
_:where(td,th):first-child{pl:0}
_:where(td,th):last-child{pr:0}
_:where(td,th){bb:1;solid;fade-92/.06;_p:6;_b:fade-4/.04@dark}
_:where(th){font:fade-78;_font:14;_text:left;_font:fade-12@dark}
_:where(th,p_code,li_code,a,mark){font:semibold;_font:medium@dark}
_:where(ul){list-style-type:disc}
_:where(ul,ol,blockquote){pl:1em}
_:where(video,img){max-width:full}
_:where(video){mx:auto}
_:where(img){mx:auto}
_:where(a,mark){text-underline-offset:3}
_:where(hr){h:2;_bg:fade-10;_bg:fade-70@dark;_my:1em}"><h1 id=mapper>Mapper</h1><h2 id=mapperregistry>MapperRegistry</h2><p><code>MapperRegistry</code> 是 Mapper 接口及其对应的代理对象工厂的注册中心。</p><p><code>Configuration</code> 是 MyBatis 全局性的配置对象，在 MyBatis 初始化的过程中，所有配置信息会被解析成相应的对象并记录到 <code>Configuration</code> 对象中。</p><h3 id=knownmappers>knownMappers</h3><p><code>MapperRegistry</code> 类中的 <code>knownMappers</code> 用做具体保存。</p><p><code>key</code> 是 <code>Mapper</code> 接口对应的 <code>Class</code> 对象，<code>value</code> 为 <code>MapperProxyFactory</code> 工厂对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?&gt;</span>, MapperProxyFactory<span style=color:#f92672>&lt;?&gt;&gt;</span> knownMappers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span></code></pre></div><h3 id=addmapper>addMapper</h3><p><code>addMapper</code> 会将接口类和包装后的对象放入到 <code>knownMappers</code> 对象中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addMapper</span>(Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> type) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (type.<span style=color:#a6e22e>isInterface</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (hasMapper(type)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BindingException(<span style=color:#e6db74>&#34;Type &#34;</span> <span style=color:#f92672>+</span> type <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; is already known to the MapperRegistry.&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> loadCompleted <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      knownMappers.<span style=color:#a6e22e>put</span>(type, <span style=color:#66d9ef>new</span> MapperProxyFactory<span style=color:#f92672>&lt;&gt;</span>(type));
</span></span><span style=display:flex><span>      <span style=color:#75715e>// It&#39;s important that the type is added before the parser is run</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// otherwise the binding may automatically be attempted by the</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// mapper parser. If the type is already known, it won&#39;t try.</span>
</span></span><span style=display:flex><span>      MapperAnnotationBuilder parser <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MapperAnnotationBuilder(config, type);
</span></span><span style=display:flex><span>      parser.<span style=color:#a6e22e>parse</span>();
</span></span><span style=display:flex><span>      loadCompleted <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>loadCompleted) {
</span></span><span style=display:flex><span>        knownMappers.<span style=color:#a6e22e>remove</span>(type);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=getmapper>getMapper</h3><p>当使用 <code>SqlSession</code> 类中的 <code>&lt;T> T getMapper(Class&lt;T> type);</code> 方法获取 Mapper 时，会转发到 <code>MapperRegistry</code> 的 <code>getMapper</code> 方法进行具体处理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span>(<span style=color:#e6db74>&#34;unchecked&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>getMapper</span>(Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> type, SqlSession sqlSession) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> MapperProxyFactory<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> mapperProxyFactory <span style=color:#f92672>=</span> (MapperProxyFactory<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>) knownMappers.<span style=color:#a6e22e>get</span>(type);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (mapperProxyFactory <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BindingException(<span style=color:#e6db74>&#34;Type &#34;</span> <span style=color:#f92672>+</span> type <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; is not known to the MapperRegistry.&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mapperProxyFactory.<span style=color:#a6e22e>newInstance</span>(sqlSession);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BindingException(<span style=color:#e6db74>&#34;Error getting mapper instance. Cause: &#34;</span> <span style=color:#f92672>+</span> e, e);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=mapperproxyfactory>MapperProxyFactory</h2><h3 id=mapperinterface>mapperInterface</h3><p><code>MapperProxyFactory</code> 中的 <code>mapperInterface</code> 为 Mapper 接口类。</p><h3 id=newinstance>newInstance</h3><p><code>newInstance</code> 的返回值 <code>T</code> 为 Mapper 接口类型（JDK 动态代理需要配合接口使用）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MapperProxyFactory</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> mapperInterface;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Method, MapperMethodInvoker<span style=color:#f92672>&gt;</span> methodCache <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MapperProxyFactory</span>(Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> mapperInterface) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mapperInterface</span> <span style=color:#f92672>=</span> mapperInterface;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getMapperInterface</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mapperInterface;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Map<span style=color:#f92672>&lt;</span>Method, MapperMethodInvoker<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getMethodCache</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> methodCache;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@SuppressWarnings</span>(<span style=color:#e6db74>&#34;unchecked&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> T <span style=color:#a6e22e>newInstance</span>(MapperProxy<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> mapperProxy) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (T) Proxy.<span style=color:#a6e22e>newProxyInstance</span>(mapperInterface.<span style=color:#a6e22e>getClassLoader</span>(), <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]</span> { mapperInterface }, mapperProxy);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> T <span style=color:#a6e22e>newInstance</span>(SqlSession sqlSession) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> MapperProxy<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> mapperProxy <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MapperProxy<span style=color:#f92672>&lt;&gt;</span>(sqlSession, mapperInterface, methodCache);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> newInstance(mapperProxy);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=mapperproxy>MapperProxy</h2><p><code>MapperProxy</code> 类是 <code>MyBatis</code> 中最重要的类之一，通过这个代理对象，MyBatis 能够在不显式编写实现类的情况下，将对 Mapper 接口的方法调用转换为相应的 SQL 查询，并执行这些查询。</p><h3 id=invoke>invoke</h3><p>该类继承自 <code>InvocationHandler</code> 接口，通过重写 <code>invoke</code> 方法提供额外的逻辑。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MapperProxy</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> InvocationHandler, Serializable
</span></span></code></pre></div><p>如果执行的 <code>method</code> 为 <code>Object</code> 类的方法，则不进行动态代理，直接执行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span>(Object proxy, Method method, Object<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (Object.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>equals</span>(method.<span style=color:#a6e22e>getDeclaringClass</span>())) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> method.<span style=color:#a6e22e>invoke</span>(<span style=color:#66d9ef>this</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cachedInvoker(method).<span style=color:#a6e22e>invoke</span>(proxy, method, args, sqlSession);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (Throwable t) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> ExceptionUtil.<span style=color:#a6e22e>unwrapThrowable</span>(t);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=cachedinvoker>cachedInvoker</h3><p>这个方法的主要功能是从 <code>methodCache</code> 缓存中获取或创建一个 <code>MapperMethodInvoker</code>，以优化调用 Mapper 接口方法的性能。</p><p>JDK 1.8 在接口中引入了 <code>default</code> 方法，用于在具体类不提供该方法的实现的情况下，允许接口方法提供实现。</p><hr><p>MyBatis 对 <code>default</code> 方法进行了额外处理，根据是否为 <code>default</code> 方法进行不同的处理：</p><ul><li>不是 <code>default</code> 方法：使用 <code>PlainMethodInvoker</code> 类进行处理，需要交给数据库处理。</li><li>是 <code>default</code> 方法：使用 <code>DefaultMethodInvoker</code> 类进行处理，调用时，直接执行。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> MapperMethodInvoker <span style=color:#a6e22e>cachedInvoker</span>(Method method) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> MapUtil.<span style=color:#a6e22e>computeIfAbsent</span>(methodCache, method, m <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>m.<span style=color:#a6e22e>isDefault</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> PlainMethodInvoker(<span style=color:#66d9ef>new</span> MapperMethod(mapperInterface, method, sqlSession.<span style=color:#a6e22e>getConfiguration</span>()));
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (privateLookupInMethod <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DefaultMethodInvoker(getMethodHandleJava8(method));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DefaultMethodInvoker(getMethodHandleJava9(method));
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (IllegalAccessException <span style=color:#f92672>|</span> InstantiationException <span style=color:#f92672>|</span> InvocationTargetException
</span></span><span style=display:flex><span>          <span style=color:#f92672>|</span> NoSuchMethodException e) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(e);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (RuntimeException re) {
</span></span><span style=display:flex><span>    Throwable cause <span style=color:#f92672>=</span> re.<span style=color:#a6e22e>getCause</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> cause <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> re : cause;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=methodhandles>MethodHandles</h3><p><code>MethodHandles</code> 在 JDK 1.9 才引入 <code>privateLookupIn</code> 方法用于直接访问 <code>private</code> 方法。</p><p>为了支持 JDK 1.8 之前的代码，下边的代码根据不同的 JDK 版本，设计了两种方式访问私有方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>static</span> {
</span></span><span style=display:flex><span>  Method privateLookupIn;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    privateLookupIn <span style=color:#f92672>=</span> MethodHandles.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getMethod</span>(<span style=color:#e6db74>&#34;privateLookupIn&#34;</span>, Class.<span style=color:#a6e22e>class</span>, MethodHandles.<span style=color:#a6e22e>Lookup</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (NoSuchMethodException e) {
</span></span><span style=display:flex><span>    privateLookupIn <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  privateLookupInMethod <span style=color:#f92672>=</span> privateLookupIn;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Constructor<span style=color:#f92672>&lt;</span>Lookup<span style=color:#f92672>&gt;</span> lookup <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (privateLookupInMethod <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// JDK 1.8</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      lookup <span style=color:#f92672>=</span> MethodHandles.<span style=color:#a6e22e>Lookup</span>.<span style=color:#a6e22e>class</span>.<span style=color:#a6e22e>getDeclaredConstructor</span>(Class.<span style=color:#a6e22e>class</span>, <span style=color:#66d9ef>int</span>.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>      lookup.<span style=color:#a6e22e>setAccessible</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (NoSuchMethodException e) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException(
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;There is neither &#39;privateLookupIn(Class, Lookup)&#39; nor &#39;Lookup(Class, int)&#39; method in java.lang.invoke.MethodHandles.&#34;</span>,
</span></span><span style=display:flex><span>          e);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>      lookup <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  lookupConstructor <span style=color:#f92672>=</span> lookup;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=getmethodhandlejava9>getMethodHandleJava9</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> MethodHandle <span style=color:#a6e22e>getMethodHandleJava9</span>(Method method)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;?&gt;</span> declaringClass <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>getDeclaringClass</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> ((Lookup) privateLookupInMethod.<span style=color:#a6e22e>invoke</span>(<span style=color:#66d9ef>null</span>, declaringClass, MethodHandles.<span style=color:#a6e22e>lookup</span>())).<span style=color:#a6e22e>findSpecial</span>(
</span></span><span style=display:flex><span>      declaringClass, method.<span style=color:#a6e22e>getName</span>(), MethodType.<span style=color:#a6e22e>methodType</span>(method.<span style=color:#a6e22e>getReturnType</span>(), method.<span style=color:#a6e22e>getParameterTypes</span>()),
</span></span><span style=display:flex><span>      declaringClass);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=getmethodhandlejava8>getMethodHandleJava8</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> MethodHandle <span style=color:#a6e22e>getMethodHandleJava8</span>(Method method)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throws</span> IllegalAccessException, InstantiationException, InvocationTargetException {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;?&gt;</span> declaringClass <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>getDeclaringClass</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> lookupConstructor.<span style=color:#a6e22e>newInstance</span>(declaringClass, ALLOWED_MODES).<span style=color:#a6e22e>unreflectSpecial</span>(method, declaringClass);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=mappermethodinvoker>MapperMethodInvoker</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>MapperMethodInvoker</span> {
</span></span><span style=display:flex><span>  Object <span style=color:#a6e22e>invoke</span>(Object proxy, Method method, Object<span style=color:#f92672>[]</span> args, SqlSession sqlSession) <span style=color:#66d9ef>throws</span> Throwable;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=plainmethodinvoker>PlainMethodInvoker</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PlainMethodInvoker</span> <span style=color:#66d9ef>implements</span> MapperMethodInvoker {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> MapperMethod mapperMethod;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>PlainMethodInvoker</span>(MapperMethod mapperMethod) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mapperMethod</span> <span style=color:#f92672>=</span> mapperMethod;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span>(Object proxy, Method method, Object<span style=color:#f92672>[]</span> args, SqlSession sqlSession) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mapperMethod.<span style=color:#a6e22e>execute</span>(sqlSession, args);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=defaultmethodinvoker>DefaultMethodInvoker</h3><p>用于处理接口中的 <code>default</code> 方法，直接使用 <code>MethodHandle</code> 执行即可。</p><p><code>bindTo</code> 将对象绑定到 <code>MethodHandle</code> 中，调用时就不需要传递对象了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DefaultMethodInvoker</span> <span style=color:#66d9ef>implements</span> MapperMethodInvoker {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> MethodHandle methodHandle;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>DefaultMethodInvoker</span>(MethodHandle methodHandle) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>methodHandle</span> <span style=color:#f92672>=</span> methodHandle;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>invoke</span>(Object proxy, Method method, Object<span style=color:#f92672>[]</span> args, SqlSession sqlSession) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> methodHandle.<span style=color:#a6e22e>bindTo</span>(proxy).<span style=color:#a6e22e>invokeWithArguments</span>(args);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=mappermethod>MapperMethod</h2><p><code>MapperMethod</code> 中封装了 Mapper 接口中对应方法的信息，以及对应 SQL 语句的信息。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> SqlCommand command;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> MethodSignature method;
</span></span></code></pre></div><h3 id=sqlcommand>SqlCommand</h3><p><code>SqlCommand</code> 类中的 <code>name</code> 为 <code>MappedStatement</code> 的 <code>id</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String name;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> SqlCommandType type;
</span></span></code></pre></div><p><code>type</code> 为 SQL 的类型。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> SqlCommandType {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  UNKNOWN,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  INSERT,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  UPDATE,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  DELETE,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  SELECT,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  FLUSH
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=methodsignature>MethodSignature</h3><p><code>MethodSignature</code> 类中的属性保存了 Mapper 接口中方法的签名。</p><p>通过不同的返回值，<code>MyBatis</code> 可以动态的返回不同类型的值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> returnsMany;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> returnsMap;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> returnsVoid;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> returnsCursor;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> returnsOptional;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;?&gt;</span> returnType;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String mapKey;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Integer resultHandlerIndex;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Integer rowBoundsIndex;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ParamNameResolver paramNameResolver;
</span></span></code></pre></div><h3 id=execute>execute</h3><p><code>execute</code> 方法会根据不同的 <code>SqlCommandType</code> 来动态选择执行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>execute</span>(SqlSession sqlSession, Object<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>  Object result;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (command.<span style=color:#a6e22e>getType</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> INSERT: {
</span></span><span style=display:flex><span>      Object param <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>convertArgsToSqlCommandParam</span>(args);
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> rowCountResult(sqlSession.<span style=color:#a6e22e>insert</span>(command.<span style=color:#a6e22e>getName</span>(), param));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> UPDATE: {
</span></span><span style=display:flex><span>      Object param <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>convertArgsToSqlCommandParam</span>(args);
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> rowCountResult(sqlSession.<span style=color:#a6e22e>update</span>(command.<span style=color:#a6e22e>getName</span>(), param));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> DELETE: {
</span></span><span style=display:flex><span>      Object param <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>convertArgsToSqlCommandParam</span>(args);
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> rowCountResult(sqlSession.<span style=color:#a6e22e>delete</span>(command.<span style=color:#a6e22e>getName</span>(), param));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> SELECT:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (method.<span style=color:#a6e22e>returnsVoid</span>() <span style=color:#f92672>&amp;&amp;</span> method.<span style=color:#a6e22e>hasResultHandler</span>()) {
</span></span><span style=display:flex><span>        executeWithResultHandler(sqlSession, args);
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (method.<span style=color:#a6e22e>returnsMany</span>()) {
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> executeForMany(sqlSession, args);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (method.<span style=color:#a6e22e>returnsMap</span>()) {
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> executeForMap(sqlSession, args);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (method.<span style=color:#a6e22e>returnsCursor</span>()) {
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> executeForCursor(sqlSession, args);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        Object param <span style=color:#f92672>=</span> method.<span style=color:#a6e22e>convertArgsToSqlCommandParam</span>(args);
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> sqlSession.<span style=color:#a6e22e>selectOne</span>(command.<span style=color:#a6e22e>getName</span>(), param);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (method.<span style=color:#a6e22e>returnsOptional</span>() <span style=color:#f92672>&amp;&amp;</span> (result <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>method.<span style=color:#a6e22e>getReturnType</span>().<span style=color:#a6e22e>equals</span>(result.<span style=color:#a6e22e>getClass</span>()))) {
</span></span><span style=display:flex><span>          result <span style=color:#f92672>=</span> Optional.<span style=color:#a6e22e>ofNullable</span>(result);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> FLUSH:
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> sqlSession.<span style=color:#a6e22e>flushStatements</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BindingException(<span style=color:#e6db74>&#34;Unknown execution method for: &#34;</span> <span style=color:#f92672>+</span> command.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (result <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> method.<span style=color:#a6e22e>getReturnType</span>().<span style=color:#a6e22e>isPrimitive</span>() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>method.<span style=color:#a6e22e>returnsVoid</span>()) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BindingException(<span style=color:#e6db74>&#34;Mapper method &#39;&#34;</span> <span style=color:#f92672>+</span> command.<span style=color:#a6e22e>getName</span>()
</span></span><span style=display:flex><span>        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; attempted to return null from a method with a primitive return type (&#34;</span> <span style=color:#f92672>+</span> method.<span style=color:#a6e22e>getReturnType</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;).&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article></div></div></body><footer class="flex jc:center my:24"><div>Copyright © 2024, Leon Li.</div></footer></html>