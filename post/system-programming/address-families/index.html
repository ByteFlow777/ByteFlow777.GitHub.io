<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>网络地址族</title>
<link href=https://unpkg.com/@master/normal.css rel=stylesheet><script src=https://unpkg.com/@master/style@1.5.0></script><script src=https://unpkg.com/@master/styles@1.13.0></script><script src=https://unpkg.com/master-styles-group></script><style>:root{--font-sans:"LXGW WenKai GB", "Hiragino Sans GB", "冬青黑", "Microsoft YaHei", "微软雅黑", SimSun, "宋体", Helvetica, Tahoma, Arial, sans-serif}</style></head><body class="bg:fade-84@dark font:fade-16@dark font:sans"><div class="d:flex flex:column@<=sm pt:60 px:24 jc:center gap:44 word-break:break-word"><div class="max-w:800 w:full box:content-box"><article class="box:border-box pt:32"><div class="_:where(a):hover{text-decoration-color:fade}
_:where(a){text-decoration:2;underline;fade-30;_text-decoration-color:fade-70@dark}
_:where(blockquote){bl:5;solid;fade-76/.1;_bl:5;solid;fade-34/.1@dark}
_:where(code){font:90%;_v:middle}
_:where(code:not(.highlight_*,pre_*)){p:2}
_:where(del){text-decoration:1;line-through;fade-68;_text-decoration-color:red-64@dark}
_:where(figcaption){text:14;_p:10;20;0;_width:fit;_mx:auto;_font:fade-56;_font:fade-57@dark}
_:where(h1,h2,h3,h4,h5,h6){mt:1em}
_:where(h1){font:40;_font:extrabold}
_:where(h1){my:1em}
_:where(h2){font:32}
_:where(h3){font:24}
_:where(h4){font:20}
_:where(h5){font:16}
_:where(h6){font:14}
_:where(li)::marker{font:fade-44;_font:fade-68@dark}
_:where(li){pl:.375em}
_:where(mark){text-decoration:1;underline;#fce016;_bg:transparent;_text-decoration-color:rgb(252;224;22/.5)@dark}
_:where(p,li){font:fade-76;_font:16;_line-height:1.65;_font:fade-34@dark}
_:where(p,pre,blockquote,figure,ul,ol,table){my:1em}
>:first-child{mt:0!}
_:where(pre){p:20;_r:8;_overflow:auto}
_:where(pre,code:not(.highlight_*)){bg:fade-2;_bg:fade-92!@dark}
_:where(strong,b,a,code:not(.highlight_*),mark,del){font:fade-92;_font:fade-12@dark}
_:where(table){width:full;_border-spacing:0}
_:where(td){v:baseline}
_:where(td,th):first-child{pl:0}
_:where(td,th):last-child{pr:0}
_:where(td,th){bb:1;solid;fade-92/.06;_p:6;_b:fade-4/.04@dark}
_:where(th){font:fade-78;_font:14;_text:left;_font:fade-12@dark}
_:where(th,p_code,li_code,a,mark){font:semibold;_font:medium@dark}
_:where(ul){list-style-type:disc}
_:where(ul,ol,blockquote){pl:1em}
_:where(video,img){max-width:full}
_:where(video){mx:auto}
_:where(img){mx:auto}
_:where(a,mark){text-underline-offset:3}
_:where(hr){h:2;_bg:fade-10;_bg:fade-70@dark;_my:1em}"><h1 id=网络地址族>网络地址族</h1><h2 id=网络地址>网络地址</h2><p>网络地址分为 IPv4 和 IPv6，分别使用 <code>sockaddr_in</code> 和 <code>sockaddr_in6</code> 结构体表示。</p><h3 id=sockaddr_in>sockaddr_in</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>struct</span> sockaddr_in {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>sa_family_t</span>    sin_family; <span style=color:#75715e>/* address family: AF_INET */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>in_port_t</span>      sin_port;   <span style=color:#75715e>/* port in network byte order */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> in_addr sin_addr;   <span style=color:#75715e>/* internet address */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Pad to size of `struct sockaddr&#39;.  */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span> sin_zero[<span style=color:#ae81ff>8</span>];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* Internet address */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> in_addr {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span>       s_addr;     <span style=color:#75715e>/* address in network byte order */</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><ul><li><code>sin_family</code>：在 IPv4 中设为 <code>AF_INET</code>。</li><li><code>sin_port</code>：<strong>网络字节序</strong>保存的端口（0～65535）。</li><li><code>sin_addr</code>：<strong>网络字节序</strong>保存的 32 位 IP 地址信息。</li><li><code>sin_zero</code>：使 <code>sockaddr_in</code> 和 <code>sockaddr</code> 结构体大小保持一致而插入的填充位，需手动设为 0。</li></ul><blockquote><p><a href=https://man7.org/linux/man-pages/man7/ip.7.html target=_blank rel="noopener noreferrer">https://man7.org/linux/man-pages/man7/ip.7.html</a></p></blockquote><h3 id=sockaddr_in6>sockaddr_in6</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>struct</span> sockaddr_in6 {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>sa_family_t</span>     sin6_family;   <span style=color:#75715e>/* AF_INET6 */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>in_port_t</span>       sin6_port;     <span style=color:#75715e>/* port number */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span>        sin6_flowinfo; <span style=color:#75715e>/* IPv6 flow information */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> in6_addr sin6_addr;     <span style=color:#75715e>/* IPv6 address */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span>        sin6_scope_id; <span style=color:#75715e>/* Scope ID (new in Linux 2.4) */</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> in6_addr {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span>   s6_addr[<span style=color:#ae81ff>16</span>];   <span style=color:#75715e>/* IPv6 address */</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><ul><li><code>sin6_family</code>：在 IPv6 中总设为 <code>AF_INET6</code>。</li><li><code>sin6_port</code>：<strong>网络字节序</strong>保存的端口（0～65535）。</li><li><code>sin6_flowinfo</code>：IPv6 流信息（不广泛使用）。</li><li><code>sin6_addr</code>：表示 IPv6 地址的结构体，定义为 <code>struct in6_addr</code>。</li><li><code>sin6_scope_id</code>：范围标识符（用于链路本地和站点本地地址）。</li></ul><blockquote><p><a href=https://man7.org/linux/man-pages/man7/ipv6.7.html target=_blank rel="noopener noreferrer">https://man7.org/linux/man-pages/man7/ipv6.7.html</a></p></blockquote><h2 id=in_addr-和-in6_addr>in_addr 和 in6_addr</h2><h3 id=in_addr>in_addr</h3><p>我们比较熟悉的 IPv4 地址表示方法为<strong>点分十进制表示法</strong>，如：201.123.235.213。</p><p>而 <code>in_addr</code> 结构体使用 <code>uint32_t</code> 保存 IPv4 地址，我们需要将字符串形式的 IPv4 地址转为 32 位整数表示。</p><hr><p><code>inet_addr</code> 函数可用于转换，该函数在转换的同时会进行网络字节序的转换。</p><p><code>inet_ntoa</code> 函数则相反，将 <code>in_addr</code> 结构体转为字符串。</p><p><strong>注意：</strong><code>inet_ntoa</code> 函数返回的是一个指向静态缓冲区的指针，最好将返回值拷贝到其它地方，以免被覆盖。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;arpa/inet.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>in_addr_t</span> <span style=color:#a6e22e>inet_addr</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>cp);
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>inet_ntoa</span>(<span style=color:#66d9ef>struct</span> in_addr in);
</span></span></code></pre></div><p>也可以使用 <code>inet_aton</code> 函数，该函数将结果直接保存到传入的 <code>inp</code> 结构体中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;arpa/inet.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>inet_aton</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>cp, <span style=color:#66d9ef>struct</span> in_addr <span style=color:#f92672>*</span>inp);
</span></span></code></pre></div><h3 id=in6_addr>in6_addr</h3><p><code>sockaddr_in5</code> 结构体中的 <code>in6_addr</code> 结构体包含一个 <code>unsigned char</code> 类型的成员 <code>s6_addr</code>，用于存储 128 位的 IPv6 地址。</p><p><code>inet_pton</code> 函数中的 <code>af</code> 参数必须为 <code>AF_INET</code> 和 <code>AF_INET6</code>，分别处理 IPv4 和 IPv6 协议。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;arpa/inet.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>inet_pton</span>(<span style=color:#66d9ef>int</span> af, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>restrict</span> src, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>restrict</span> dst);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>inet_ntop</span>(<span style=color:#66d9ef>int</span> af, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>restrict</span> src,
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>char</span> dst[<span style=color:#66d9ef>restrict</span> .size], <span style=color:#66d9ef>socklen_t</span> size);
</span></span></code></pre></div><h2 id=网络地址初始化>网络地址初始化</h2><h3 id=ipv4>IPv4</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;arpa/inet.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>address <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;211.123.211.168&#34;</span>; <span style=color:#75715e>// IP 地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>port <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;7890&#34;</span>;               <span style=color:#75715e>// 端口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in addr;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>addr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(addr));
</span></span><span style=display:flex><span>    addr.sin_family <span style=color:#f92672>=</span> AF_INET;                 <span style=color:#75715e>// IPv4;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    addr.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_addr</span>(address); <span style=color:#75715e>// 设置 IP 地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    addr.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(<span style=color:#a6e22e>atoi</span>(port));         <span style=color:#75715e>// 以网络字节序设置端口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h3 id=ipv6>IPv6</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;arpa/inet.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>address <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;2001:0db8:85a3:0000:0000:8a2e:0370:7334&#34;</span>; <span style=color:#75715e>// IPv6 地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>port <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;7890&#34;</span>;                     <span style=color:#75715e>// 端口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in6 addr;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>addr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(addr));
</span></span><span style=display:flex><span>    addr.sin6_family <span style=color:#f92672>=</span> AF_INET6;                   <span style=color:#75715e>// IPv6
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>inet_pton</span>(AF_INET6, address, <span style=color:#f92672>&amp;</span>addr.sin6_addr); <span style=color:#75715e>// 设置 IP 地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    addr.sin6_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(<span style=color:#a6e22e>atoi</span>(port));            <span style=color:#75715e>// 以网络字节序设置端口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=思考>思考</h2><p>为什么 <code>sockaddr_in</code> 和 <code>sockaddr_in6</code> 分别表示 IPv4 和 IPv6 协议，还要额外使用 <code>sa_family_t</code> 指定协议版本呢？</p><blockquote><p>因为 <code>connect</code>、<code>bind</code>、和 <code>accept</code> 函数第二个参数都接收 <code>sockaddr</code> 结构体。因此，需要使用 <code>sa_family</code> 用于区分不同版本的协议。通过使用通用的 <code>sockaddr</code> 结构体，该函数不仅可以处理 IPv4 和 IPv6 协议，还可处理其它协议。这样，就不需要为每种协议都提供对应的函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>struct</span> sockaddr {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>sa_family_t</span>     sa_family;      <span style=color:#75715e>/* Address family */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span>            sa_data[];      <span style=color:#75715e>/* Socket address */</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></blockquote></div></article></div></div></body><footer class="flex jc:center my:24"><div>Copyright © 2024, Leon Li.</div></footer></html>