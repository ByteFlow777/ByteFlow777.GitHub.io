<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>JVM 常量池</title>
<link href=https://unpkg.com/@master/normal.css rel=stylesheet><script src=https://unpkg.com/@master/style@1.5.0></script><script src=https://unpkg.com/@master/styles@1.13.0></script><script src=https://unpkg.com/master-styles-group></script><link rel=stylesheet href=https://chinese-fonts-cdn.deno.dev/packages/syst/dist/SourceHanSerifCN/result.css><style>body{font-family:source han serif cn vf}</style></head><body class="bg:fade-84@dark font:fade-16@dark"><div class="d:flex flex:column@<=sm pt:60 px:24 jc:center gap:44 word-break:break-word"><div class="max-w:800 w:full box:content-box"><article class="box:border-box pt:32"><div class="_:where(a):hover{text-decoration-color:fade}
_:where(a){text-decoration:2;underline;fade-30;_text-decoration-color:fade-70@dark}
_:where(blockquote){bl:5;solid;fade-76/.1;_bl:5;solid;fade-34/.1@dark}
_:where(code){font:90%;_v:middle}
_:where(code:not(.highlight_*,pre_*)){p:2}
_:where(del){text-decoration:1;line-through;fade-68;_text-decoration-color:red-64@dark}
_:where(figcaption){text:14;_p:10;20;0;_width:fit;_mx:auto;_font:fade-56;_font:fade-57@dark}
_:where(h1,h2,h3,h4,h5,h6){mt:1em}
_:where(h1){font:40;_font:extrabold}
_:where(h1){my:1em}
_:where(h2){font:32}
_:where(h3){font:24}
_:where(h4){font:20}
_:where(h5){font:16}
_:where(h6){font:14}
_:where(li)::marker{font:fade-44;_font:fade-68@dark}
_:where(li){pl:.375em}
_:where(mark){text-decoration:1;underline;#fce016;_bg:transparent;_text-decoration-color:rgb(252;224;22/.5)@dark}
_:where(p,li){font:fade-76;_font:16;_line-height:1.65;_font:fade-34@dark}
_:where(p,pre,blockquote,figure,ul,ol,table){my:1em}
>:first-child{mt:0!}
_:where(pre){p:20;_r:8;_overflow:auto}
_:where(pre,code:not(.highlight_*)){bg:fade-2;_bg:fade-92!@dark}
_:where(strong,b,a,code:not(.highlight_*),mark,del){font:fade-92;_font:fade-12@dark}
_:where(table){width:full;_border-spacing:0}
_:where(td){v:baseline}
_:where(td,th):first-child{pl:0}
_:where(td,th):last-child{pr:0}
_:where(td,th){bb:1;solid;fade-92/.06;_p:6;_b:fade-4/.04@dark}
_:where(th){font:fade-78;_font:14;_text:left;_font:fade-12@dark}
_:where(th,p_code,li_code,a,mark){font:semibold;_font:medium@dark}
_:where(ul){list-style-type:disc}
_:where(ul,ol,blockquote){pl:1em}
_:where(video,img){max-width:full}
_:where(video){mx:auto}
_:where(img){mx:auto}
_:where(a,mark){text-underline-offset:3}
_:where(hr){h:2;_bg:fade-10;_bg:fade-70@dark;_my:1em}"><h1 id=jvm-常量池>JVM 常量池</h1><p>常量池是一个表，所有的表项都有以下的格式。<code>tag</code> 表示表项的类型，<code>info</code> 用于表示 <code>tag</code> 类型所需要存储的信息。</p><pre tabindex=0><code>cp_info {
    u1 tag;
    u1 info[];
}
</code></pre><p>常量池索引是从 1 开始的，不是直接从 0 开始。如果需要表达“不引用任何一个常量池项目”的含义，可以把索引值设置为 0 来表示。</p><h2 id=为什么设计常量池>为什么设计常量池？</h2><h3 id=复用>复用</h3><p>常量池允许在类文件中共享常量数据。例如，字符串常量、类名、方法名和字段名等。可以避免了在类文件中多次存储相同的常量，从而减少类文件的大小。</p><hr><p>下边的代码，通过 <code>$javac Main.java</code> 编译后，使用 <code>$javap -v Main.class</code> 进行反编译。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        String str <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello World!&#34;</span>;
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(str);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Hello World!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><pre tabindex=0><code>public class io.github.ileonli.Main
  minor version: 0
  major version: 65
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #21                         // io/github/ileonli/Main
  super_class: #2                         // java/lang/Object
  interfaces: 0, fields: 0, methods: 2, attributes: 1
Constant pool:
   #1 = Methodref          #2.#3          // java/lang/Object.&#34;&lt;init&gt;&#34;:()V
   #2 = Class              #4             // java/lang/Object
   #3 = NameAndType        #5:#6          // &#34;&lt;init&gt;&#34;:()V
   #4 = Utf8               java/lang/Object
   #5 = Utf8               &lt;init&gt;
   #6 = Utf8               ()V
   #7 = String             #8             // Hello World!
   #8 = Utf8               Hello World!
   #9 = Fieldref           #10.#11        // java/lang/System.out:Ljava/io/PrintStream;
  #10 = Class              #12            // java/lang/System
  #11 = NameAndType        #13:#14        // out:Ljava/io/PrintStream;
  #12 = Utf8               java/lang/System
  #13 = Utf8               out
  #14 = Utf8               Ljava/io/PrintStream;
  #15 = Methodref          #16.#17        // java/io/PrintStream.println:(Ljava/lang/String;)V
  #16 = Class              #18            // java/io/PrintStream
  #17 = NameAndType        #19:#20        // println:(Ljava/lang/String;)V
  #18 = Utf8               java/io/PrintStream
  #19 = Utf8               println
  #20 = Utf8               (Ljava/lang/String;)V
  #21 = Class              #22            // io/github/ileonli/Main
  #22 = Utf8               io/github/ileonli/Main
  #23 = Utf8               Code
  #24 = Utf8               LineNumberTable
  #25 = Utf8               main
  #26 = Utf8               ([Ljava/lang/String;)V
  #27 = Utf8               SourceFile
  #28 = Utf8               Main.java
{
  public io.github.ileonli.Main();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V
         4: return
      LineNumberTable:
        line 3: 0

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=2, args_size=1
         0: ldc           #7                  // String Hello World!
         2: astore_1
         3: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;
         6: aload_1
         7: invokevirtual #15                 // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        10: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;
        13: ldc           #7                  // String Hello World!
        15: invokevirtual #15                 // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        18: return
      LineNumberTable:
        line 5: 0
        line 6: 3
        line 7: 10
        line 8: 18
}
</code></pre><p>从 class 文件的反编译结果可以看出 <code>main</code> 方法中有大量的复用：</p><ol><li><code>0: ldc #7</code> 和 <code>13: ldc #7</code> 使用 <code>#7</code> 来代替 <code>Hello World!</code> 字符串。</li><li><code>3: getstatic #9</code> 和 <code>10: getstatic #9</code> 使用 <code>#9</code> 来代替 <code>java/lang/System.out:Ljava/io/PrintStream;</code> 变量。</li><li><code>7: invokevirtual #15</code> 和 <code>15: invokevirtual #15</code> 使用 <code>#15</code> 来代替 <code>java/io/PrintStream.println:(Ljava/lang/String;)V</code> 方法。</li></ol><h3 id=符号引用>符号引用</h3><p>JVM 中的指令并不依赖于运行时类、接口、类实例或数组的布局。相反，指令通过常量池表中的符号信息进行引用。</p><p>这意味着 JVM 指令在运行时操作时，不需要直接处理类或对象的内存布局，而是通过常量池中的符号来找到所需的类、方法、字段等信息。</p><hr><p>如我们有个类 <code>Example</code>，其中有个方法为 <code>printMesssage</code>。在编译后的 class 文件中，常量池会有以下条目：</p><ol><li><code>CONSTANT_Class_info</code>：表示 <code>Example</code> 类。</li><li><code>CONSTANT_NameAndType_info</code>：表示 <code>printMessage</code> 方法的名字和类型。</li><li><code>CONSTANT_Methodref_info</code>：表示 <code>Example</code> 类中的 <code>printMessage</code> 方法。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Example</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>printMessage</span>() {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Hello, World!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用 <code>$javap -v Example.class</code> 反编译得到的结果。</p><p>JVM 指令例如 <code>invokevirtual</code> 会使用这些常量池条目来确定具体要调用的方法，而不是直接引用方法在内存中的地址。</p><pre tabindex=0><code>public class io.github.ileonli.Example
  minor version: 0
  major version: 65
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #21                         // io/github/ileonli/Example
  super_class: #2                         // java/lang/Object
  interfaces: 0, fields: 0, methods: 2, attributes: 1
Constant pool:
   #1 = Methodref          #2.#3          // java/lang/Object.&#34;&lt;init&gt;&#34;:()V
   #2 = Class              #4             // java/lang/Object
   #3 = NameAndType        #5:#6          // &#34;&lt;init&gt;&#34;:()V
   #4 = Utf8               java/lang/Object
   #5 = Utf8               &lt;init&gt;
   #6 = Utf8               ()V
   #7 = Fieldref           #8.#9          // java/lang/System.out:Ljava/io/PrintStream;
   #8 = Class              #10            // java/lang/System
   #9 = NameAndType        #11:#12        // out:Ljava/io/PrintStream;
  #10 = Utf8               java/lang/System
  #11 = Utf8               out
  #12 = Utf8               Ljava/io/PrintStream;
  #13 = String             #14            // Hello, World!
  #14 = Utf8               Hello, World!
  #15 = Methodref          #16.#17        // java/io/PrintStream.println:(Ljava/lang/String;)V
  #16 = Class              #18            // java/io/PrintStream
  #17 = NameAndType        #19:#20        // println:(Ljava/lang/String;)V
  #18 = Utf8               java/io/PrintStream
  #19 = Utf8               println
  #20 = Utf8               (Ljava/lang/String;)V
  #21 = Class              #22            // io/github/ileonli/Example
  #22 = Utf8               io/github/ileonli/Example
  #23 = Utf8               Code
  #24 = Utf8               LineNumberTable
  #25 = Utf8               printMessage
  #26 = Utf8               SourceFile
  #27 = Utf8               Example.java
{
  public io.github.ileonli.Example();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V
         4: return
      LineNumberTable:
        line 3: 0

  public void printMessage();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #13                 // String Hello, World!
         5: invokevirtual #15                 // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: return
      LineNumberTable:
        line 5: 0
        line 6: 8
}
</code></pre><h2 id=常量池项目类型>常量池项目类型</h2><p>常量池中的表项共有下边几种：</p><table><thead><tr><th>Constant Kind</th><th>Tag</th><th>Class File Format</th><th>Java SE</th></tr></thead><tbody><tr><td>CONSTANT_Utf8</td><td>1</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_Integer</td><td>3</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_Float</td><td>4</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_Long</td><td>5</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_Double</td><td>6</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_Class</td><td>7</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_String</td><td>8</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_Fieldref</td><td>9</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_Methodref</td><td>10</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_InterfaceMethodref</td><td>11</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_NameAndType</td><td>12</td><td>45.3</td><td>1.0.2</td></tr><tr><td>CONSTANT_MethodHandle</td><td>15</td><td>51.0</td><td>7</td></tr><tr><td>CONSTANT_MethodType</td><td>16</td><td>51.0</td><td>7</td></tr><tr><td>CONSTANT_Dynamic</td><td>17</td><td>55.0</td><td>11</td></tr><tr><td>CONSTANT_InvokeDynamic</td><td>18</td><td>51.0</td><td>7</td></tr><tr><td>CONSTANT_Module</td><td>19</td><td>53.0</td><td>9</td></tr><tr><td>CONSTANT_Package</td><td>20</td><td>53.0</td><td>9</td></tr></tbody></table><h3 id=constant_class_info>CONSTANT_Class_info</h3><p><code>CONSTANT_Class_info</code> 用于表示一个类，或者一个接口。</p><p><code>name_index</code> 为指向常量池表项的索引，该表项必须为 <code>CONSTANT_Utf8_info</code>。</p><pre tabindex=0><code>CONSTANT_Class_info {
    u1 tag;
    u2 name_index;
}
</code></pre></div></article></div></div></body><footer class="flex jc:center my:24"><div>Copyright © 2024, Leon Li.</div></footer></html>