<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Leon Li"><meta property="og:url" content="https://byteflow777.github.io/post/java/spi/"><link rel=canonical href=https://byteflow777.github.io/post/java/spi/><link rel=alternate type=application/atom+xml href=https://byteflow777.github.ioindex.xml title="Leon Li"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/byteflow777.github.io"},"articleSection":"post","name":"Java SPI 机制","headline":"Java SPI 机制","description":"简单使用 为使用 Java 操作数据库，我们需要提供驱动程序。为支持多种数据库（如：MySQL、PostgreSQL、Oracle），提供 DatabaseBaseDriver 接口。\npackage org.example; public interface DatabaseBaseDriver { void open(); void close(); String getName(); } 通过实现 DatabaseBaseDriver 接口，分别创建了操作 MySQL 和 PostgreSQL 数据库的驱动。\npackage org.example; public class MysqlDriver implements DatabaseBaseDriver { @Override public void open() { System.out.println(\u0026#34;open MySQL connection\u0026#34;); } @Override public void close() { System.out.println(\u0026#34;close MySQL connection\u0026#34;); } @Override public String getName() { return \u0026#34;mysql\u0026#34;; } } package org.example; public class PostgresqlDriver implements DatabaseBaseDriver { @Override public void open() { System.","inLanguage":"en-US","author":"Leon Li","creator":"Leon Li","publisher":"Leon Li","accountablePerson":"Leon Li","copyrightHolder":"Leon Li","copyrightYear":"2023","datePublished":"2023-02-15 00:00:00 \u002b0000 UTC","dateModified":"2023-02-15 00:00:00 \u002b0000 UTC","url":"https:\/\/byteflow777.github.io\/post\/java\/spi\/","keywords":[]}</script><title>Java SPI 机制</title><meta property="og:title" content="Java SPI 机制"><meta property="og:type" content="article"><meta property="og:description" content="简单使用 为使用 Java 操作数据库，我们需要提供驱动程序。为支持多种数据库（如：MySQL、PostgreSQL、Oracle），提供 DatabaseBaseDriver 接口。
package org.example; public interface DatabaseBaseDriver { void open(); void close(); String getName(); } 通过实现 DatabaseBaseDriver 接口，分别创建了操作 MySQL 和 PostgreSQL 数据库的驱动。
package org.example; public class MysqlDriver implements DatabaseBaseDriver { @Override public void open() { System.out.println(&amp;#34;open MySQL connection&amp;#34;); } @Override public void close() { System.out.println(&amp;#34;close MySQL connection&amp;#34;); } @Override public String getName() { return &amp;#34;mysql&amp;#34;; } } package org.example; public class PostgresqlDriver implements DatabaseBaseDriver { @Override public void open() { System."><meta name=description content="简单使用 为使用 Java 操作数据库，我们需要提供驱动程序。为支持多种数据库（如：MySQL、PostgreSQL、Oracle），提供 DatabaseBaseDriver 接口。
package org.example; public interface DatabaseBaseDriver { void open(); void close(); String getName(); } 通过实现 DatabaseBaseDriver 接口，分别创建了操作 MySQL 和 PostgreSQL 数据库的驱动。
package org.example; public class MysqlDriver implements DatabaseBaseDriver { @Override public void open() { System.out.println(&amp;#34;open MySQL connection&amp;#34;); } @Override public void close() { System.out.println(&amp;#34;close MySQL connection&amp;#34;); } @Override public String getName() { return &amp;#34;mysql&amp;#34;; } } package org.example; public class PostgresqlDriver implements DatabaseBaseDriver { @Override public void open() { System."><meta property="og:locale" content><meta property="og:image" content><style>body{font-family:-apple-system,BlinkMacSystemFont,segoe ui,pingfang sc,hiragino sans gb,microsoft yahei,helvetica neue,Helvetica,Arial,sans-serif,apple color emoji,segoe ui emoji,segoe ui symbol;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#4183c4;text-decoration:none}a:hover{color:#1a0dab;text-decoration:underline}li{margin-top:4px;margin-bottom:4px}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body blockquote{margin:0;padding:0 .75em;color:#57606a;border-left:.25em solid #d0d7de}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;background-color:#f6f9ff;border-radius:6px}.markdown-body pre>code{padding:0;font-size:90%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-content img{max-width:100%;display:block;margin:12px auto 0}.post-header{margin-bottom:30px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:10px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{text-align:center}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=/index.xml rel=alternate type=application/rss+xml title="Leon Li"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet></head><body><article class=post id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-subtitle></div></header><div class="row center-xs header-items"><div class=header-item><a href=/ target=_blank>Home</a></div><div class=header-item><a href=/about target=_blank>About</a></div></div><div class="row end-xs"></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>Java SPI 机制</h1></header><div class="post-content markdown-body"><h2 id=简单使用>简单使用</h2><p>为使用 Java 操作数据库，我们需要提供驱动程序。为支持多种数据库（如：MySQL、PostgreSQL、Oracle），提供 <code>DatabaseBaseDriver</code> 接口。</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#ff6ac1>package</span> org.example<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>interface</span> <span style=color:#f3f99d>DatabaseBaseDriver</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>open</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>    <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>close</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>    String <span style=color:#57c7ff>getName</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><p>通过实现 <code>DatabaseBaseDriver</code> 接口，分别创建了操作 <code>MySQL</code> 和 <code>PostgreSQL</code> 数据库的驱动。</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#ff6ac1>package</span> org.example<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>MysqlDriver</span> <span style=color:#ff5c57>implements</span> DatabaseBaseDriver <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>open</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>out</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>println</span><span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;open MySQL connection&#34;</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>close</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>out</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>println</span><span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;close MySQL connection&#34;</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> String <span style=color:#57c7ff>getName</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> <span style=color:#5af78e>&#34;mysql&#34;</span><span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#ff6ac1>package</span> org.example<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>PostgresqlDriver</span> <span style=color:#ff5c57>implements</span> DatabaseBaseDriver <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>open</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>out</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>println</span><span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;open PostgreSQL connection&#34;</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>close</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>out</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>println</span><span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;close PostgreSQL connection&#34;</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff9f43>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> String <span style=color:#57c7ff>getName</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> <span style=color:#5af78e>&#34;postgresql&#34;</span><span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><p>为方便对数据库驱动的管理和使用，对驱动的所有操作均使用 <code>DatabaseBaseDriverManager</code> 类。</p><ul><li><code>getDrivers</code> 方法用于获取注册到 Manager 中的所有驱动。</li><li><code>getDriverByName</code> 方法通过保存的名称获取保存到 Manager 中的驱动。</li><li><code>registerDriver</code> 方法用于注册驱动到 Manager 中。</li></ul><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#ff6ac1>package</span> org.example<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>DatabaseBaseDriverManager</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> <span style=color:#ff5c57>static</span> <span style=color:#ff5c57>final</span> Map<span style=color:#ff6ac1>&lt;</span>String<span style=color:#ff6ac1>,</span> DatabaseBaseDriver<span style=color:#ff6ac1>&gt;</span> drivers
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> ConcurrentHashMap<span style=color:#ff6ac1>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> List<span style=color:#ff6ac1>&lt;</span>DatabaseBaseDriver<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>getDrivers</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        Collection<span style=color:#ff6ac1>&lt;</span>DatabaseBaseDriver<span style=color:#ff6ac1>&gt;</span> storedDrivers <span style=color:#ff6ac1>=</span> drivers<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>values</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>new</span> ArrayList<span style=color:#ff6ac1>&lt;&gt;(</span>storedDrivers<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> DatabaseBaseDriver <span style=color:#57c7ff>getDriverByName</span><span style=color:#ff6ac1>(</span>String name<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> drivers<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>get</span><span style=color:#ff6ac1>(</span>name<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>registerDriver</span><span style=color:#ff6ac1>(</span>SDatabaseBaseDriver driver<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        drivers<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>put</span><span style=color:#ff6ac1>(</span>driver<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>getName</span><span style=color:#ff6ac1>(),</span> driver<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><p>当我们需要使用 MySQL 时，需要在使用驱动前通过 <code>registerDriver</code> 方法注册 MySQL 驱动实例。</p><p>在使用数据库时，先通过 <code>getDriverByName</code> 获取驱动实例，再通过获取到的驱动实例操作数据库。</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#ff6ac1>package</span> org.example<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>Main</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>run</span><span style=color:#ff6ac1>(</span>String sql<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        DatabaseBaseDriver mysql <span style=color:#ff6ac1>=</span>
</span></span><span style=display:flex><span>                DatabaseBaseDriverManager<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>getDriverByName</span><span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;mysql&#34;</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>        mysql<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>open</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>        <span style=color:#78787e>// use given sql to operate db
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>        mysql<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>close</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>main</span><span style=color:#ff6ac1>(</span>String<span style=color:#ff6ac1>[]</span> args<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        DatabaseBaseDriverManager<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>registerDriver</span><span style=color:#ff6ac1>(</span><span style=color:#ff6ac1>new</span> MysqlDriver<span style=color:#ff6ac1>());</span>
</span></span><span style=display:flex><span>        run<span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;SELECT * FROM `user`&#34;</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><p>此时的代码耦合度很高，当添加或删除驱动时，就需要更改代码。有没有机制可以允许我们不直接在程序里直接指明，而由具体的实现动态装配呢？</p><hr><p>Java 6 引入了 SPI（Service Provider Interface）机制，用于加载服务的实现，使用步骤具体如下：</p><ol><li>在 resources 文件夹中新建 <a href=https://docs.oracle.com/javase/7/docs/technotes/guides/jar/jar.html>META-INF</a> 文件夹。</li><li>在 META-INF 文件夹中创建 services 文件夹。</li><li>在 services 文件夹中创建名为接口全类名的文件，并在此文件中添加提供服务实现的类的全类名。</li></ol><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>resources
</span></span><span style=display:flex><span>    └─META-INF
</span></span><span style=display:flex><span>        └─services
</span></span><span style=display:flex><span>            └─org.example.DatabaseBaseDriver
</span></span><span style=display:flex><span>                org.example.MysqlDriver
</span></span><span style=display:flex><span>                org.example.PostgresqlDriver
</span></span></code></pre></div><p>改造 <code>DatabaseBaseDriverManager</code> 类，在获取驱动实例前，通过 <code>ensureInitialized</code> 方法确保驱动实例已经初始化。</p><p><code>ServiceLoader</code> 在加载接口时，会去 META-INF/services 下找接口的全限定类名文件，再根据里面的内容加载相应的实现类。</p><p>通过 <code>Iterator</code> 调用 <code>next()</code> 方法迭代时，会使用反射动态创建具体的实现类，具体逻辑流程在 <code>java.util.ServiceLoader.ProviderImpl#newInstance</code> 方法中。</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#ff6ac1>package</span> org.example<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>DatabaseBaseDriverManager</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> <span style=color:#ff5c57>static</span> <span style=color:#ff5c57>final</span> Map<span style=color:#ff6ac1>&lt;</span>String<span style=color:#ff6ac1>,</span> DatabaseBaseDriver<span style=color:#ff6ac1>&gt;</span> drivers
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> ConcurrentHashMap<span style=color:#ff6ac1>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> <span style=color:#ff5c57>static</span> <span style=color:#ff5c57>final</span> AtomicBoolean isInit <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>new</span> AtomicBoolean<span style=color:#ff6ac1>(</span><span style=color:#ff6ac1>false</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>private</span> <span style=color:#ff5c57>static</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>ensureInitialized</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>if</span> <span style=color:#ff6ac1>(!</span>isInit<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>get</span><span style=color:#ff6ac1>())</span> <span style=color:#ff6ac1>{</span> <span style=color:#78787e>// drivers have not initialize
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>            ServiceLoader<span style=color:#ff6ac1>&lt;</span>DatabaseBaseDriver<span style=color:#ff6ac1>&gt;</span> loader <span style=color:#ff6ac1>=</span>
</span></span><span style=display:flex><span>                    ServiceLoader<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>load</span><span style=color:#ff6ac1>(</span>DatabaseBaseDriver<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>class</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Iterator<span style=color:#ff6ac1>&lt;</span>DatabaseBaseDriver<span style=color:#ff6ac1>&gt;</span> itr <span style=color:#ff6ac1>=</span> loader<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>iterator</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>while</span> <span style=color:#ff6ac1>(</span>itr<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>hasNext</span><span style=color:#ff6ac1>())</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>                DatabaseBaseDriver driver <span style=color:#ff6ac1>=</span> itr<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>next</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>                registerDriver<span style=color:#ff6ac1>(</span>driver<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            isInit<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>compareAndSet</span><span style=color:#ff6ac1>(</span><span style=color:#ff6ac1>false</span><span style=color:#ff6ac1>,</span> <span style=color:#ff6ac1>true</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> List<span style=color:#ff6ac1>&lt;</span>DatabaseBaseDriver<span style=color:#ff6ac1>&gt;</span> <span style=color:#57c7ff>getDrivers</span><span style=color:#ff6ac1>()</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        ensureInitialized<span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>        Collection<span style=color:#ff6ac1>&lt;</span>DatabaseBaseDriver<span style=color:#ff6ac1>&gt;</span> storedDrivers <span style=color:#ff6ac1>=</span> drivers<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>values</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>new</span> ArrayList<span style=color:#ff6ac1>&lt;&gt;(</span>storedDrivers<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> DatabaseBaseDriver <span style=color:#57c7ff>getDriverByName</span><span style=color:#ff6ac1>(</span>String name<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        ensureInitialized<span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>return</span> drivers<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>get</span><span style=color:#ff6ac1>(</span>name<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>registerDriver</span><span style=color:#ff6ac1>(</span>DatabaseBaseDriver driver<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        drivers<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>putIfAbsent</span><span style=color:#ff6ac1>(</span>driver<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>getName</span><span style=color:#ff6ac1>(),</span> driver<span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><p>在使用 SPI 技术后，可以直接获取驱动，无需使用代码添加驱动。</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#ff6ac1>package</span> org.example<span style=color:#ff6ac1>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>Main</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#ff5c57>static</span> <span style=color:#9aedfe>void</span> <span style=color:#57c7ff>main</span><span style=color:#ff6ac1>(</span>String<span style=color:#ff6ac1>[]</span> args<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        DatabaseBaseDriver mysql 
</span></span><span style=display:flex><span>                <span style=color:#ff6ac1>=</span> DatabaseBaseDriverManager<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>getDriverByName</span><span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;mysql&#34;</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>        mysql<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>open</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>        <span style=color:#78787e>// do something
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>        mysql<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>close</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><h2 id=jdk-中的-drivermanager>JDK 中的 DriverManager</h2><p>第二种改进的方法正是 JDK 中 <code>java.sql.DriverManager</code> 类所作的操作。</p><p>代码片段截取自 <code>java.sql.DriverManager</code> 类中 <code>ensureDriversInitialized</code> 方法，省略非关键代码。</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>ServiceLoader<span style=color:#ff6ac1>&lt;</span>Driver<span style=color:#ff6ac1>&gt;</span> loadedDrivers <span style=color:#ff6ac1>=</span> ServiceLoader<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>load</span><span style=color:#ff6ac1>(</span>Driver<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>class</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>Iterator<span style=color:#ff6ac1>&lt;</span>Driver<span style=color:#ff6ac1>&gt;</span> driversIterator <span style=color:#ff6ac1>=</span> loadedDrivers<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>iterator</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e>/* Load these drivers, so that they can be instantiated.
</span></span></span><span style=display:flex><span><span style=color:#78787e> * It may be the case that the driver class may not be there
</span></span></span><span style=display:flex><span><span style=color:#78787e> * i.e. there may be a packaged driver with the service class
</span></span></span><span style=display:flex><span><span style=color:#78787e> * as implementation of java.sql.Driver but the actual class
</span></span></span><span style=display:flex><span><span style=color:#78787e> * may be missing. In that case a java.util.ServiceConfigurationError
</span></span></span><span style=display:flex><span><span style=color:#78787e> * will be thrown at runtime by the VM trying to locate
</span></span></span><span style=display:flex><span><span style=color:#78787e> * and load the service.
</span></span></span><span style=display:flex><span><span style=color:#78787e> *
</span></span></span><span style=display:flex><span><span style=color:#78787e> * Adding a try catch block to catch those runtime errors
</span></span></span><span style=display:flex><span><span style=color:#78787e> * if driver not available in classpath but it&#39;s
</span></span></span><span style=display:flex><span><span style=color:#78787e> * packaged as service and that service is there in classpath.
</span></span></span><span style=display:flex><span><span style=color:#78787e> */</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>try</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>while</span> <span style=color:#ff6ac1>(</span>driversIterator<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>hasNext</span><span style=color:#ff6ac1>())</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        driversIterator<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>next</span><span style=color:#ff6ac1>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span> <span style=color:#ff6ac1>catch</span> <span style=color:#ff6ac1>(</span>Throwable t<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>// Do nothing
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>null</span><span style=color:#ff6ac1>;</span>
</span></span></code></pre></div><h2 id=具体应用>具体应用</h2><h3 id=插件>插件</h3><p>插件只需要实现系统所提供的插件接口，再通过 SPI 技术即可方便的装载。</p><h3 id=数据库驱动>数据库驱动</h3><p>JDK 中提供了 <code>java.sql.Driver</code> 接口，所有的驱动类必须实现，同时提供了 <code>java.sql.DriverManager</code> 管理所有的驱动。</p><p>可以看到 MySQL 驱动使用了 SPI 机制，java.sql.Driver 文件中内容为 com.mysql.cj.jdbc.Driver。</p><p><img src=/img/post/java/mysql-driver-spi.png alt></p><p><code>com.mysql.cj.jdbc.Driver</code> 类使用静态代码块注册到 <code>java.sql.DriverManager</code> 中，在第一次类加载时运行。</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#ff5c57>public</span> <span style=color:#ff5c57>class</span> <span style=color:#f3f99d>Driver</span> <span style=color:#ff5c57>extends</span> NonRegisteringDriver <span style=color:#ff5c57>implements</span> java<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>sql</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>Driver</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>//
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#78787e>// Register ourselves with the DriverManager
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#78787e>//
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#ff5c57>static</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>try</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>            java<span style=color:#ff6ac1>.</span><span style=color:#57c7ff>sql</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>DriverManager</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>registerDriver</span><span style=color:#ff6ac1>(</span><span style=color:#ff6ac1>new</span> Driver<span style=color:#ff6ac1>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>}</span> <span style=color:#ff6ac1>catch</span> <span style=color:#ff6ac1>(</span>SQLException E<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff6ac1>throw</span> <span style=color:#ff6ac1>new</span> RuntimeException<span style=color:#ff6ac1>(</span><span style=color:#5af78e>&#34;Can&#39;t register driver!&#34;</span><span style=color:#ff6ac1>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#78787e>/**
</span></span></span><span style=display:flex><span><span style=color:#78787e>     * Construct a new driver and register it with DriverManager
</span></span></span><span style=display:flex><span><span style=color:#78787e>     * 
</span></span></span><span style=display:flex><span><span style=color:#78787e>     * @throws SQLException
</span></span></span><span style=display:flex><span><span style=color:#78787e>     *             if a database error occurs.
</span></span></span><span style=display:flex><span><span style=color:#78787e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#ff5c57>public</span> <span style=color:#57c7ff>Driver</span><span style=color:#ff6ac1>()</span> <span style=color:#ff5c57>throws</span> SQLException <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>        <span style=color:#78787e>// Required for Class.forName().newInstance()
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#ff6ac1>}</span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>}</span>
</span></span></code></pre></div><h2 id=总结>总结</h2><p>可以通过 SPI 机制可以很方便进行系统解耦，提供程序的可扩展性。该机制同时也是”约定大于配置“思想的体现。</p><blockquote><p><a href=https://docs.oracle.com/javase/tutorial/ext/basics/spi.html>https://docs.oracle.com/javase/tutorial/ext/basics/spi.html</a>
<a href=https://www.baeldung.com/java-spi>https://www.baeldung.com/java-spi</a></p></blockquote></div><div class="row middle-xs"><div class=col-xs-12></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=site-footer></div></div></div></article><script></script></body></html>