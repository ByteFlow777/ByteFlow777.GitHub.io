<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://ileonli.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><link rel=canonical href=https://ileonli.github.io/posts/java/jdbc/><title>Java 数据库连接 (JDBC)</title></head><body><header id=banner></header><main id=content><article><header id=post-header><h1>Java 数据库连接 (JDBC)</h1><div><time>2023-09-19</time></div></header><blockquote><p>翻译：https://docs.oracle.com/javase/tutorial/jdbc/basics/index.html</p></blockquote><h2 id=使用-jdbc-处理-sql>使用 JDBC 处理 SQL</h2><p>一般来说，使用 JDBC 处理 SQL 语句需要以下步骤：</p><ol><li>Establishing a connection.</li><li>Create a statement.</li><li>Execute the query.</li><li>Process the ResultSet object.</li><li>Close the connection.</li></ol><hr><h1 id=建立连接>建立连接</h1><p>首先，你需要与你使用的数据源建立连接。数据源可以是 DBMS、遗留（legacy）的文件系统或具有相应 JDBC 驱动的其它数据源。通常，一个 JDBC 应用使用下面两个类中的一个连接到目标数据源：</p><ul><li><p><code>DriverManager</code>：通过这个完全实现的类可将应用程序连接到数据源，数据源由数据库 URL 指定。当此类第一次尝试建立连接时，会自动加载类路径下所有的 JDBC 4.0 驱动。请注意，你的程序必须手动加载 4.0 版本之前的 JDBC 驱动。</p></li><li><p><code>DataSource</code>：该接口优于 <code>DriverManager</code>，对于底层数据源的细节对应用透明。设置 <code>DataSource</code> 对象的属性以使其代表特定的数据源。</p></li></ul><h2 id=使用-drivermanager-类>使用 DriverManager 类</h2><p>使用 <code>DeriverManager</code> 类连接到 DBMS 涉及调用 <code>DriverManager.getConnection</code> 方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Connection</span> <span class=nf>getConnection</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Connection</span> <span class=n>conn</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Properties</span> <span class=n>connectionProps</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Properties</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>connectionProps</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;user&#34;</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>userName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>connectionProps</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;password&#34;</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>dbms</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;mysql&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>DriverManager</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                   <span class=s>&#34;jdbc:&#34;</span> <span class=o>+</span> <span class=k>this</span><span class=o>.</span><span class=na>dbms</span> <span class=o>+</span> <span class=s>&#34;://&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                   <span class=k>this</span><span class=o>.</span><span class=na>serverName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                   <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=k>this</span><span class=o>.</span><span class=na>portNumber</span> <span class=o>+</span> <span class=s>&#34;/&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>connectionProps</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>dbms</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;derby&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>DriverManager</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                   <span class=s>&#34;jdbc:&#34;</span> <span class=o>+</span> <span class=k>this</span><span class=o>.</span><span class=na>dbms</span> <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                   <span class=k>this</span><span class=o>.</span><span class=na>dbName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                   <span class=s>&#34;;create=true&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>connectionProps</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Connected to database&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>conn</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><code>DriverManager.getConnection</code> 方法建立了数据库连接。此方法需要数据库 URL，取决于你的 DBMS。下边是一些数据库 URL 的例子：</p><ol><li>MySQL：<code>jdbc:mysql://localhost:3306/</code>，其中 <code>localhost</code> 是托管数据库服务器的名称，3306 是端口。</li><li>Java DB：<code>jdbc:derby:testdb;create=true</code>，其中 <code>testdb</code> 是要连接的数据库名称，<code>create=true</code> 指明 DBMS 创建数据库。<blockquote><p>注意：此 URL 可与 Java DB 嵌入式驱动程序建立数据库连接。Java DB 还包括一个网络客户端驱动程序，它使用不同的 URL。</p></blockquote></li></ol><p>此方法使用 <code>Properties</code> 对象指定访问 DBMS 所需的用户名和密码。</p><p>注意：</p><ul><li>通常，在数据库 URL 中，你还需要指定想要连接的现存数据库名称。例如：<code>jdbc:mysql://localhost:3306/mysql</code> 展示了连接到数据库名为 <code>mysql</code> 的 MySQL 数据库 URL。本教程中的示例使用的 URL 未指定特定数据库，因为示例创建了一个新数据库。</li><li>在 JDBC 之前的版本中，为获得连接，你首先需要调用 <code>Class.forName</code> 方法初始化 JDBC 驱动。此方法需要类型为 <code>java.sql.Driver</code> 的对象。每个 JDBC 驱动都包含一个或多个实现 <code>java.sql.Driver</code> 接口的类。Java DB 的驱动是 <code>org.apache.derby.jdbc.EmbeddedDriver</code> 和 <code>org.apache.derby.jdbc.ClientDriver</code>。MySQL Connector/J 之一是 <code>com.mysql.cj.jdbc.Driver</code>。查阅你使用的 DBMS 驱动的文档来获取实现 <code>java.sql.Driver</code> 接口的类名。在类路径找到的 JDBC 4.0 驱动会被自动加载。（然而，你需要通过 <code>Class.forName</code> 方法手动加载 JDBC 4.0 之前的所有驱动）。</li></ul><p>此方法返回 <code>Connection</code> 对象，此对象表示与 DBMS 或指定数据库的连接。通过此对象查询数据库。</p><h2 id=指定数据库连接-url>指定数据库连接 URL</h2><p>数据库连接 URL 是 DBMS JDBC 驱动连接到数据库所使用的字符串。它可以包含一些信息，如搜索数据库的位置、要连接的数据库名称以及配置属性等。数据库连接 URL 的语法由 DBMS 规定。</p><h3 id=java-db-数据库连接-url>Java DB 数据库连接 URL</h3><p>下边是 Java DB 数据库连接 URL 的语法：</p><pre tabindex=0><code>jdbc:derby:[subsubprotocol:][databaseName][;attribute=value]*
</code></pre><ul><li><code>subsubprotocol</code>：指定 Java DB 应在何处搜索数据库，在目录、内存、类路径或者 JAR 文件中。该部分通常被省略。</li><li><code>databaseName</code> 是应该连接到的数据库名称。</li><li><code>attribute=value</code> 代表是可选的，以分号分割的符号列表。这些属性允许你指导 Java DB 执行各种任务：包括：<ul><li>创建在连接 URL 指定的数据库。</li><li>加密在连接 URL 指定的数据库。</li><li>指定存储日志和追踪信息的目录。</li><li>指定连接到数据库的用户名和密码。</li></ul></li></ul><h3 id=mysql-connectorj-数据库-url>MySQL Connector/J 数据库 URL</h3><p>下边是 MySQL Connector/J 数据库连接 URL 的语法：</p><pre tabindex=0><code>jdbc:mysql://[host][,failoverhost...]
    [:port]/[database]
    [?propertyName1][=propertyValue1]
    [&amp;propertyName2][=propertyValue2]...
</code></pre><ul><li><code>host:port</code>：是数据库所在计算机的主机名和端口号。如果未指定，默认的 <code>host</code> 和 <code>port</code> 分别是 127.0.0.1 和 3306。</li><li><code>database</code>：是数据库连接的名称。如果未指定，建立连接时不使用任何数据库。</li><li><code>failover</code>：是备用数据库的名称（MySQL Connector/J 支持故障转移）。</li><li><code>propertyName=propertyValue</code>：是可选的，使用 & 分割的属性列表。这些属性允许你指导 MySQL Connector/J 执行各种任务。</li></ul><hr><h1 id=使用-datasource-对象连接>使用 <code>DataSource</code> 对象连接</h1><p>此节覆盖 <code>DataSource</code> 对象，使用此对象是连接数据源的优先方法。</p><h2 id=使用-datasource-对象获得连接>使用 <code>DataSource</code> 对象获得连接</h2><hr><h1 id=处理-sql-异常>处理 SQL 异常</h1><h2 id=sqlexception-概述><code>SQLException</code> 概述</h2><p>当 JDBC 与数据库交互遇到错误时，它抛出一个 <code>SQLException</code> 实例而不是 <code>Exception</code>。此上下文中的数据源表示 <code>Connection</code> 对象所连接的数据库。<code>SQLException</code> 实例包含以下信息，可以帮助你推断造成错误的原因：</p><ul><li>错误的描述。通过调用 <code>SQLException.getMessage</code> 方法获取 <code>String</code> 类型的描述。</li><li><code>SQLState</code> 代码。这些代码及其含义已由 ISO/ANSI 和 Open Group (X/Open) 标准化，尽管有些代码已保留给数据库供应商自行定义。该 <code>String</code> 对象由五个字母数字字符组成。通过调用 <code>SQLException.getSQLState</code> 方法获取此代码。</li><li>引起此异常的原因。<code>SQLException</code> 实例可能具有因果关系，该关系由导致抛出 <code>SQLException</code> 实例的一个或多个 <code>Throwable</code> 对象组成。要获取此原因链，递归地调用 <code>SQLException.getCause</code> 方法直到返回 <code>null</code> 值。</li><li>对任何链式（chained）异常的引用。如果发生多个错误，则通过该链引用异常。通过对引发的异常调用方法 <code>SQLException.getNextException</code> 来获取异常。</li></ul><h2 id=获取异常>获取异常</h2><hr><h1 id=使用-preparedstatement>使用 <code>PreparedStatement</code></h1><h2 id=preparedstatement-概述><code>PreparedStatement</code> 概述</h2><p>在某些情况下，使用 <code>PreparedStatement</code> 对象向数据库发送 SQL 语句更加方便。这种特殊类型的语句派生自更通用的 <code>Statement</code> 类。</p></article></main><footer id=footer></footer></body></html>