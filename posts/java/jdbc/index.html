<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://ileonli.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><link rel=canonical href=https://ileonli.github.io/posts/java/jdbc/><title>Java 数据库连接 (JDBC)</title></head><body><header id=banner></header><main id=content><article><header id=post-header><h1>Java 数据库连接 (JDBC)</h1><div><time>2023-09-19</time></div></header><blockquote><p>翻译自：https://docs.oracle.com/javase/tutorial/jdbc/basics/index.html</p></blockquote><hr><h1 id=使用-jdbc-处理-sql-语句>使用 JDBC 处理 SQL 语句</h1><blockquote><p><a href=https://docs.oracle.com/javase/tutorial/jdbc/basics/processingsqlstatements.html>https://docs.oracle.com/javase/tutorial/jdbc/basics/processingsqlstatements.html</a></p></blockquote><p>一般来说，使用 JDBC 处理 SQL 语句需要以下步骤：</p><ol><li>建立连接。</li><li>创建 <code>Statement</code> 对象。</li><li>执行查询。</li><li>处理 <code>ResultSet</code> 对象。</li><li>关闭连接。</li></ol><p>本页面使用 <a href=https://docs.oracle.com/javase/tutorial/jdbc/basics/examples/JDBCTutorial/src/com/oracle/tutorial/jdbc/CoffeesTable.java>CoffeesTable.viewTable</a> 教程示例中的方法来演示这些步骤。该方法输出 <code>COFFEES</code> 表的内容。本教程稍后将更详细地讨论此方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>viewTable</span><span class=o>(</span><span class=n>Connection</span> <span class=n>con</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>query</span> <span class=o>=</span> <span class=s>&#34;select COF_NAME, SUP_ID, PRICE, SALES, TOTAL from COFFEES&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>(</span><span class=n>Statement</span> <span class=n>stmt</span> <span class=o>=</span> <span class=n>con</span><span class=o>.</span><span class=na>createStatement</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ResultSet</span> <span class=n>rs</span> <span class=o>=</span> <span class=n>stmt</span><span class=o>.</span><span class=na>executeQuery</span><span class=o>(</span><span class=n>query</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>rs</span><span class=o>.</span><span class=na>next</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>coffeeName</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getString</span><span class=o>(</span><span class=s>&#34;COF_NAME&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>supplierID</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;SUP_ID&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>float</span> <span class=n>price</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getFloat</span><span class=o>(</span><span class=s>&#34;PRICE&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>sales</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;SALES&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>total</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;TOTAL&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>coffeeName</span> <span class=o>+</span> <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>supplierID</span> <span class=o>+</span> <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>price</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                            <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>sales</span> <span class=o>+</span> <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>total</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SQLException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>JDBCTutorialUtilities</span><span class=o>.</span><span class=na>printSQLException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=建立连接>建立连接</h2><p>首先，需要要使用的数据源建立连接。数据源可以是 DBMS、传统（legacy）文件系统或其他具有相应 JDBC 驱动程序的数据源。此连接由连接对象表示。</p><h2 id=创建-statement>创建 Statement</h2><p><code>Statement</code> 是表示 SQL 语句的接口。执行 <code>Statement</code> 对象会生成 <code>ResultSet</code> 对象，这是一个代表数据库结果集的数据表。创建 <code>Statement</code> 对象需要使用 <code>Connection</code> 对象。</p><p>例如：<code>CoffeesTable.viewTable</code> 使用以下代码创建 <code>Statement</code> 对象：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>stmt</span> <span class=o>=</span> <span class=n>con</span><span class=o>.</span><span class=na>createStatement</span><span class=o>();</span>
</span></span></code></pre></div><p>有三种不同的 <code>Statement</code>：</p><ul><li><code>Statement</code>：用于实现简单的且没有参数的 SQL 语句。</li><li><code>PreparedStatement</code>：扩展的 <code>Statement</code>，预编译 SQL 语句，该 SQL 可能包含输入参数。</li><li><code>CallableStatement</code>：扩展的 <code>PreparedStatement</code>，用于执行可能包含输入和输出参数的存储过程。</li></ul><h2 id=执行查询>执行查询</h2><p>为了执行查询，需要调用 <code>Statement</code> 方法：</p><ul><li><code>execute</code>：如果查询返回的第一个对象是一个 <code>ResultSet</code> 对象，则返回 <code>true</code>。如果查询可能返回一个或多个 <code>ResultSet</code> 对象，则使用该方法。通过重复调用 <code>Statement.getResultSet</code> 来读取查询返回的 <code>ResultSet</code> 对象。</li><li><code>executeQuery</code>：返回一个<code>ResultSet</code> 对象。</li><li><code>executeUpdate</code>：返回一个整数，表示被 SQL 语句影响的行数。如果您使用 <code>INSERT</code>、<code>DELETE</code> 或 <code>UPDATE</code> 等SQL 语句，请使用此方法。</li></ul><p>例如：<code>CoffeesTable.viewTable</code> 使用以下代码执行 <code>Statement</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>ResultSet</span> <span class=n>rs</span> <span class=o>=</span> <span class=n>stmt</span><span class=o>.</span><span class=na>executeQuery</span><span class=o>(</span><span class=n>query</span><span class=o>);</span>
</span></span></code></pre></div><h2 id=处理-resultset-对象>处理 <code>ResultSet</code> 对象</h2><p>您可以通过游标（cursor）访问 <code>ResultSet</code> 对象中的数据。请注意，该游标不是数据库游标。该游标是一个指针，指向 <code>ResultSet</code> 对象中的一行数据。最初，光标位于第一行之前。您可以调用 <code>ResultSet</code> 对象中定义的各种方法来移动光标。</p><p>例如，<code>CoffeesTable.viewTable</code> 重复调用 <code>ResultSet.next</code> 方法将光标向前移动一行。每次调用<code>next</code> 时，该方法都会输出光标当前所在行的数据：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl>    <span class=n>ResultSet</span> <span class=n>rs</span> <span class=o>=</span> <span class=n>stmt</span><span class=o>.</span><span class=na>executeQuery</span><span class=o>(</span><span class=n>query</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>(</span><span class=n>rs</span><span class=o>.</span><span class=na>next</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>coffeeName</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getString</span><span class=o>(</span><span class=s>&#34;COF_NAME&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>supplierID</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;SUP_ID&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>float</span> <span class=n>price</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getFloat</span><span class=o>(</span><span class=s>&#34;PRICE&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>sales</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;SALES&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>total</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;TOTAL&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>coffeeName</span> <span class=o>+</span> <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>supplierID</span> <span class=o>+</span> <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>price</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                            <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>sales</span> <span class=o>+</span> <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>total</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ..
</span></span></span></code></pre></div><h2 id=关闭连接>关闭连接</h2><p>当使用完 <code>Connection</code>、<code>Statement</code> 或 <code>ResultSet</code> 对象后，调用其 <code>close</code> 方法立即释放正在使用的资源。</p><p>此外，使用 try-with-resources 语句自动关闭 <code>Connection</code>、<code>Statement</code> 和 <code>ResultSet</code> 对象，无论是否抛出 <code>SQLException</code> 异常（当 JDBC 在与数据源交互期间遇到错误时，它会抛出 <code>SQLException</code>）。自动资源语句由 try 语句和一个或多个声明的资源组成。例如 <code>CoffeesTable.viewTable</code> 方法自动关闭其 <code>Statement</code> 对象，如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>viewTable</span><span class=o>(</span><span class=n>Connection</span> <span class=n>con</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>query</span> <span class=o>=</span> <span class=s>&#34;select COF_NAME, SUP_ID, PRICE, SALES, TOTAL from COFFEES&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>(</span><span class=n>Statement</span> <span class=n>stmt</span> <span class=o>=</span> <span class=n>con</span><span class=o>.</span><span class=na>createStatement</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ResultSet</span> <span class=n>rs</span> <span class=o>=</span> <span class=n>stmt</span><span class=o>.</span><span class=na>executeQuery</span><span class=o>(</span><span class=n>query</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=o>(</span><span class=n>rs</span><span class=o>.</span><span class=na>next</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>coffeeName</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getString</span><span class=o>(</span><span class=s>&#34;COF_NAME&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>supplierID</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;SUP_ID&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>float</span> <span class=n>price</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getFloat</span><span class=o>(</span><span class=s>&#34;PRICE&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>sales</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;SALES&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>total</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;TOTAL&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>coffeeName</span> <span class=o>+</span> <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>supplierID</span> <span class=o>+</span> <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>price</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                            <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>sales</span> <span class=o>+</span> <span class=s>&#34;, &#34;</span> <span class=o>+</span> <span class=n>total</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SQLException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>JDBCTutorialUtilities</span><span class=o>.</span><span class=na>printSQLException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>下面是一个 try-with-resources 语句，它声明了一个资源 <code>stmt</code>，当 try 块终止时，该资源将自动关闭：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=k>try</span> <span class=o>(</span><span class=n>Statement</span> <span class=n>stmt</span> <span class=o>=</span> <span class=n>con</span><span class=o>.</span><span class=na>createStatement</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div><hr><h1 id=建立连接-1>建立连接</h1><blockquote><p><a href=https://docs.oracle.com/javase/tutorial/jdbc/basics/connecting.html>https://docs.oracle.com/javase/tutorial/jdbc/basics/connecting.html</a></p></blockquote><p>首先，你需要与你使用的数据源建立连接。数据源可以是 DBMS、传统（legacy）文件系统或具其他具有相应 JDBC 驱动程序的数据源。通常，一个 JDBC 应用使用下面两个类中的一个连接到目标数据源：</p><ul><li><code>DriverManager</code>：通过这个完全实现的类可将应用程序连接到数据源，数据源由数据库 URL 指定。当此类第一次尝试建立连接时，会自动加载类路径下所有的 JDBC 4.0 驱动。请注意，你的程序必须手动加载 4.0 版本之前的 JDBC 驱动。</li><li><code>DataSource</code>：该接口优于 <code>DriverManager</code>，对于底层数据源的细节对应用透明。设置 <code>DataSource</code> 对象的属性以使其代表特定的数据源。</li></ul><h2 id=使用-drivermanager-类>使用 DriverManager 类</h2><p>使用 <code>DeriverManager</code> 类连接到 DBMS 涉及调用 <code>DriverManager.getConnection</code> 方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Connection</span> <span class=nf>getConnection</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Connection</span> <span class=n>conn</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Properties</span> <span class=n>connectionProps</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Properties</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>connectionProps</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;user&#34;</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>userName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>connectionProps</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;password&#34;</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>dbms</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;mysql&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>DriverManager</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                   <span class=s>&#34;jdbc:&#34;</span> <span class=o>+</span> <span class=k>this</span><span class=o>.</span><span class=na>dbms</span> <span class=o>+</span> <span class=s>&#34;://&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                   <span class=k>this</span><span class=o>.</span><span class=na>serverName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                   <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=k>this</span><span class=o>.</span><span class=na>portNumber</span> <span class=o>+</span> <span class=s>&#34;/&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>connectionProps</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>dbms</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=s>&#34;derby&#34;</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>DriverManager</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                   <span class=s>&#34;jdbc:&#34;</span> <span class=o>+</span> <span class=k>this</span><span class=o>.</span><span class=na>dbms</span> <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                   <span class=k>this</span><span class=o>.</span><span class=na>dbName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                   <span class=s>&#34;;create=true&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                   <span class=n>connectionProps</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Connected to database&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>conn</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><code>DriverManager.getConnection</code> 方法建立了数据库连接。此方法需要数据库 URL，取决于你的 DBMS。下边是一些数据库 URL 的例子：</p><ol><li>MySQL：<code>jdbc:mysql://localhost:3306/</code>，其中 <code>localhost</code> 是托管数据库服务器的名称，3306 是端口。</li><li>Java DB：<code>jdbc:derby:testdb;create=true</code>，其中 <code>testdb</code> 是要连接的数据库名称，<code>create=true</code> 指明 DBMS 创建数据库。<blockquote><p>注意：此 URL 可与 Java DB 嵌入式驱动程序建立数据库连接。Java DB 还包括一个网络客户端驱动程序，它使用不同的 URL。</p></blockquote></li></ol><p>此方法使用 <code>Properties</code> 对象指定访问 DBMS 所需的用户名和密码。</p><p>注意：</p><ul><li>通常，在数据库 URL 中，你还需要指定想要连接的现存数据库名称。例如：<code>jdbc:mysql://localhost:3306/mysql</code> 展示了连接到数据库名为 <code>mysql</code> 的 MySQL 数据库 URL。本教程中的示例使用的 URL 未指定特定数据库，因为示例创建了一个新数据库。</li><li>在 JDBC 之前的版本中，为获得连接，你首先需要调用 <code>Class.forName</code> 方法初始化 JDBC 驱动。此方法需要类型为 <code>java.sql.Driver</code> 的对象。每个 JDBC 驱动都包含一个或多个实现 <code>java.sql.Driver</code> 接口的类。Java DB 的驱动是 <code>org.apache.derby.jdbc.EmbeddedDriver</code> 和 <code>org.apache.derby.jdbc.ClientDriver</code>。MySQL Connector/J 之一是 <code>com.mysql.cj.jdbc.Driver</code>。查阅你使用的 DBMS 驱动的文档来获取实现 <code>java.sql.Driver</code> 接口的类名。在类路径找到的 JDBC 4.0 驱动会被自动加载。（然而，你需要通过 <code>Class.forName</code> 方法手动加载 JDBC 4.0 之前的所有驱动）。</li></ul><p>此方法返回 <code>Connection</code> 对象，此对象表示与 DBMS 或指定数据库的连接。通过此对象查询数据库。</p><h2 id=指定数据库连接-url>指定数据库连接 URL</h2><p>数据库连接 URL 是 DBMS JDBC 驱动连接到数据库所使用的字符串。它可以包含一些信息，如搜索数据库的位置、要连接的数据库名称以及配置属性等。数据库连接 URL 的语法由 DBMS 规定。</p><h3 id=java-db-数据库连接-url>Java DB 数据库连接 URL</h3><p>下边是 Java DB 数据库连接 URL 的语法：</p><pre tabindex=0><code>jdbc:derby:[subsubprotocol:][databaseName][;attribute=value]*
</code></pre><ul><li><code>subsubprotocol</code>：指定 Java DB 应在何处搜索数据库，在目录、内存、类路径或者 JAR 文件中。该部分通常被省略。</li><li><code>databaseName</code> 是应该连接到的数据库名称。</li><li><code>attribute=value</code> 代表是可选的，以分号分割的符号列表。这些属性允许你指导 Java DB 执行各种任务：包括：<ul><li>创建在连接 URL 指定的数据库。</li><li>加密在连接 URL 指定的数据库。</li><li>指定存储日志和追踪信息的目录。</li><li>指定连接到数据库的用户名和密码。</li></ul></li></ul><h3 id=mysql-connectorj-数据库-url>MySQL Connector/J 数据库 URL</h3><p>下边是 MySQL Connector/J 数据库连接 URL 的语法：</p><pre tabindex=0><code>jdbc:mysql://[host][,failoverhost...]
    [:port]/[database]
    [?propertyName1][=propertyValue1]
    [&amp;propertyName2][=propertyValue2]...
</code></pre><ul><li><code>host:port</code>：是数据库所在计算机的主机名和端口号。如果未指定，默认的 <code>host</code> 和 <code>port</code> 分别是 127.0.0.1 和 3306。</li><li><code>database</code>：是数据库连接的名称。如果未指定，建立连接时不使用任何数据库。</li><li><code>failover</code>：是备用数据库的名称（MySQL Connector/J 支持故障转移）。</li><li><code>propertyName=propertyValue</code>：是可选的，使用 & 分割的属性列表。这些属性允许你指导 MySQL Connector/J 执行各种任务。</li></ul><hr><h1 id=使用-datasource-对象连接>使用 <code>DataSource</code> 对象连接</h1><blockquote><p><a href=https://docs.oracle.com/javase/tutorial/jdbc/basics/sqldatasources.html>https://docs.oracle.com/javase/tutorial/jdbc/basics/sqldatasources.html</a></p></blockquote><p>本节将介绍 <code>DataSource</code> 对象，该对象是获取数据源连接的首选方式。除了稍后将介绍的其他优点外，数据源对象还可以提供连接池和分布式事务。这一功能对于企业数据库计算至关重要。特别是，它是企业 JavaBeans（EJB）技术不可或缺的一部分。</p><p>本节将向您展示如何使用 <code>DataSource</code> 接口获取连接，以及如何使用分布式事务和连接池。这两项操作对 JDBC 应用程序的代码改动都很小。</p><p>系统管理员通常使用工具（如 Apache Tomcat 或 Oracle WebLogic Server）来部署实现这些操作的类，部署这些类所需的工作因所部署的 <code>DataSource</code> 对象的类型而异。因此，本节的大部分内容将用于展示系统管理员如何设置环境，以便程序员可以使用 <code>DataSource</code> 对象获取连接。</p><h2 id=使用-datasource-对象获得连接>使用 <code>DataSource</code> 对象获得连接</h2><p>在建立连接章节中，你学习了如何使用 <code>DriverManager</code> 类获取连接。本节将向你展示如何使用<code>DataSource</code> 对象获取与数据源的连接，这也是首选方法。</p><p>实现 <code>DataSource</code> 的类实例化的对象代表特定的 DBMS 或其他数据源（如文件）。数据源对象代表特定的 DBMS 或其他数据源（如文件）。如果一家公司使用多个数据源，它将为每个数据源部署一个单独的 <code>DataSource</code> 对象。数据源接口由驱动程序供应商实现。它可以通过三种不同的方式实现：</p><ul><li>基本的 <code>DataSource</code> 实现会生成标准 <code>Connection</code> 对象，这些对象不会被池化，也不会在分布式事务中使用。</li><li>支持连接池的 <code>DataSource</code> 实现会生成参与连接池的 <code>Connection</code> 对象，即可以循环使用的连接。</li><li>支持分布式事务的 <code>DataSource</code> 实现生成的 <code>Connection</code> 对象可用于分布式事务，即访问两个或多个 DBMS 服务器的事务。</li></ul><p>JDBC 驱动程序应至少包含一个基本的数据源实现。例如：Java DB 的 JDBC 驱动程序包含 <code>org.apache.derby.jdbc.ClientDataSource</code> 实现，MySQL 则包含 <code>com.mysql.jdbc.jdbc2.optional.MysqlDataSource</code>。如果客户端在 Java 8 compact profile 2 上运行，则 Java DB 的JDBC 驱动程序为 <code>org.apache.derby.jdbc.BasicClientDataSource40</code>。本教程的示例需要compact profile 3 或更高版本。</p><p>支持分布式事务的 <code>DataSource</code> 类通常也实现了对连接池的支持。例如：EJB 供应商提供的 <code>DataSource</code> 类也同时支持连接池和分布式事务。</p><p>假设前面例子中生意兴隆的 Coffee Break 连锁店的店主决定通过在互联网上销售咖啡来进一步扩张。由于预计会有大量在线业务，店主肯定需要连接池。打开和关闭连接需要大量的开销，而且店主预计这个在线订购系统将需要大量的查询和更新。有了连接池，连接池就可以反复使用，避免了每次访问数据库都要创建新连接的开销。此外，所有者现在还有第二个数据库管理系统，其中包含最近收购的咖啡烘焙公司的数据。这意味着所有者希望能够编写同时使用旧 DBMS 服务器和新 DBMS 服务器的分布式事务。</p><p>连锁店老板重新配置了计算机系统，以便为新的、更大的客户群提供服务。店主购买了最新的 JDBC 驱动程序和与之配合使用的 EJB 应用程序服务器，以便能够使用分布式事务并提高连接池带来的性能。许多 JDBC 驱动程序都与最近购买的 EJB 服务器兼容。所有者现在有一个三层架构，中间层是新的 EJB 应用程序服务器和 JDBC 驱动程序，第三层是两个 DBMS 服务器。发出请求的客户端计算机是第一层。</p><h2 id=部署基本-datasource-对象>部署基本 <code>DataSource</code> 对象</h2><p>系统管理员需要部署 <code>DataSource</code> 对象，以便 Coffee Break 的编程团队可以开始使用它们。部署数据源对象包括三项任务：</p><ol><li>创建 <code>DataSource</code> 类的实例。</li><li>设置属性。</li><li>通过使用 Java 命名和目录接口（JNDI）API 的命名服务进行注册。</li></ol><p>首先，考虑最基本的情况，即使用 <code>DataSource</code> 接口的基本实现，也就是不支持连接池或分布式事务的实现。在这种情况下，只需部署一个 <code>DataSource</code> 对象。<code>DataSource</code> 的基本实现与 <code>DriverManager</code> 类产生的连接类型相同。</p><h3 id=创建-datasource-类的实例并设置属性>创建 <code>DataSource</code> 类的实例并设置属性</h3><p>假设一家公司只需要 <code>DataSource</code> 的基本实现，并从 JDBC 供应商 DB Access, Inc. 该驱动程序包含实现 <code>DataSource</code> 接口的 <code>com.dbaccess.BasicDataSource</code> 类。下面的代码节选创建了一个 <code>BasicDataSource</code> 类的实例并设置了其属性。部署 <code>BasicDataSource</code> 实例后，程序员可以调用 <code>DataSource.getConnection</code> 方法获取与公司数据库 <code>CUSTOMER_ACCOUNTS</code> 的连接。首先，系统管理员使用默认构造函数创建 <code>BasicDataSource</code> 对象 <code>ds</code>。然后，系统管理员设置三个属性。请注意，以下代码通常由部署工具执行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>com</span><span class=o>.</span><span class=na>dbaccess</span><span class=o>.</span><span class=na>BasicDataSource</span> <span class=n>ds</span> <span class=o>=</span> <span class=k>new</span> <span class=n>com</span><span class=o>.</span><span class=na>dbaccess</span><span class=o>.</span><span class=na>BasicDataSource</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=na>setServerName</span><span class=o>(</span><span class=s>&#34;grinder&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=na>setDatabaseName</span><span class=o>(</span><span class=s>&#34;CUSTOMER_ACCOUNTS&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=na>setDescription</span><span class=o>(</span><span class=s>&#34;Customer accounts database for billing&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>变量 <code>ds</code> 代表服务器上安装的数据库 <code>CUSTOMER_ACCOUNTS</code>。任何由 <code>BasicDataSource</code> 对象 <code>ds</code> 生成的连接都将是指向数据库 <code>CUSTOMER_ACCOUNTS</code> 的连接。</p><h3 id=使用-jndi-api-在命名服务中注册数据源对象>使用 JNDI API 在命名服务中注册数据源对象</h3><p>属性设置完成后，系统管理员就可以用 JNDI（Java 命名和目录接口）命名服务注册 <code>BasicDataSource</code> 对象。所使用的特定命名服务通常由系统属性决定，在此不做显示。以下为注册 <code>BasicDataSource</code> 对象，并将其与逻辑名称 <code>jdbc/billingDB</code> 绑定的部分代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>Context</span> <span class=n>ctx</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ctx</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=s>&#34;jdbc/billingDB&#34;</span><span class=o>,</span> <span class=n>ds</span><span class=o>);</span>
</span></span></code></pre></div><p>这段代码使用 JNDI API。第一行创建一个 <code>InitialContext</code> 对象，作为名称的起点，类似于文件系统中的根目录。第二行将 <code>BasicDataSource</code> 对象 ds 与逻辑名称 <code>jdbc/billingDB</code> 关联或绑定。在接下来的代码节选中，你将给命名服务提供这个逻辑名称，然后它将返回 <code>BasicDataSource</code> 对象。逻辑名称可以是任何字符串。在本例中，公司决定使用 <code>billingDB</code> 作为 <code>CUSTOMER_ACCOUNTS</code> 数据库的逻辑名称。</p><p>在上例中，JDBC 是初始上下文下的子上下文，就像根目录下的目录是子目录一样。<code>jdbc/billingDB</code> 这个名称就像一个路径名，路径中的最后一项类似于文件名。在本例中，<code>billingDB</code> 是赋予 <code>BasicDataSource</code> 对象 <code>ds</code> 的逻辑名称。子上下文 JDBC 是为绑定到数据源对象的逻辑名称保留的，因此 JDBC 将始终是数据源逻辑名称的第一部分。</p><h3 id=使用部署后的-datasource-对象>使用部署后的 <code>DataSource</code> 对象</h3><p>系统管理员部署基本数据源实现后，程序员就可以使用它了。这意味着程序员可以给出绑定到 <code>DataSource</code> 类实例的逻辑数据源名称，而 JNDI 命名服务将返回该 <code>DataSource</code> 类的实例。然后就可以在该 <code>DataSource</code> 对象上调用 <code>getConnection</code> 方法，以获得与其所代表的数据源的连接。例如，程序员可以编写以下两行代码来获取一个数据源对象，该对象将产生与数据库 <code>CUSTOMER_ACCOUNTS</code> 的连接。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>Context</span> <span class=n>ctx</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>DataSource</span> <span class=n>ds</span> <span class=o>=</span> <span class=o>(</span><span class=n>DataSource</span><span class=o>)</span><span class=n>ctx</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=s>&#34;jdbc/billingDB&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>第一行代码获取初始上下文，作为检索数据源对象的起点。如果向方法查找提供逻辑名称 <code>jdbc/billingDB</code>，该方法将返回系统管理员在部署时绑定到 <code>jdbc/billingDB</code> 的 <code>DataSource</code> 对象。由于方法查找的返回值是 Java 对象，我们必须将其转换为更具体的 <code>DataSource</code> 类型，然后再将其赋值给变量 <code>ds</code>。</p><p>变量 <code>ds</code> 是实现了 <code>DataSource</code> 接口的 <code>com.dbaccess.BasicDataSource</code> 类的实例。调用方法 <code>ds.getConnection</code> 将生成一个连接到 <code>CUSTOMER_ACCOUNTS</code> 数据库的连接。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>Connection</span> <span class=n>con</span> <span class=o>=</span> <span class=n>ds</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=s>&#34;fernanda&#34;</span><span class=o>,</span><span class=s>&#34;brewed&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p><code>getConnection</code> 方法只需要用户名和密码，因为变量 <code>ds</code> 的属性中包含了与 <code>CUSTOMER_ACCOUNTS</code> 数据库建立连接所需的其他信息，如数据库名称和位置。</p><h3 id=datasource-对象的优势><code>DataSource</code> 对象的优势</h3><p>由于 <code>DataSource</code> 对象的属性，它比 <code>DriverManager</code> 类更适合用于获取连接。程序员不必再在应用程序中硬性编码驱动程序名称或 JDBC URL，从而使应用程序更具可移植性。此外，数据源属性也使代码维护变得更加简单。如果有更改，系统管理员可以更新数据源属性，而不必担心更改与数据源建立连接的每个应用程序。例如，如果数据源被转移到不同的服务器上，系统管理员只需将 serverName 属性设置为新的服务器名称即可。</p><p>除了可移植性和易于维护外，使用 <code>DataSource</code> 对象获取连接还具有其他优势。当 <code>DataSource</code> 接口与 <code>ConnectionPoolDataSource</code> 实现配合使用时，该 <code>DataSource</code> 类实例产生的所有连接都将自动成为池连接。同样，当 <code>DataSource</code> 类的实现与 <code>XADataSource</code> 类协同工作时，它产生的所有连接将自动成为可在分布式事务中使用的连接。下一节将介绍如何部署这些类型的数据源实现。</p><h2 id=部署其它-datasource-实现>部署其它 <code>DataSource</code> 实现</h2><p>系统管理员或其他相关人员可以部署 <code>DataSource</code> 对象，使其产生的连接是池连接。为此，首先部署 <code>ConnectionPoolDataSource</code> 对象，然后部署一个为与之配合工作而实现的 <code>DataSource</code> 对象。设置 <code>ConnectionPoolDataSource</code> 对象的属性，使其代表将产生连接的数据源。<code>ConnectionPoolDataSource</code> 对象向 JNDI 命名服务注册后，数据源对象就会被部署。一般来说，数据源对象只需设置两个属性：<code>description</code> 和 <code>dataSourceName</code>。给 <code>dataSourceName</code> 属性的值是标识先前部署的 <code>ConnectionPoolDataSource</code> 对象的逻辑名称，该对象包含建立连接所需的属性。</p><p>部署了 <code>ConnectionPoolDataSource</code> 和 <code>DataSource</code> 对象后，就可以在 <code>DataSource</code> 对象上调用 <code>DataSource.getConnection</code> 方法，获取池连接。该连接将指向 <code>ConnectionPoolDataSource</code> 对象属性中指定的数据源。</p><p>下面的示例描述了 Coffee Break 的系统管理员如何部署为提供池连接而实施的 <code>DataSource</code> 对象。系统管理员通常会使用部署工具，因此本节显示的代码片段就是部署工具要执行的代码。</p><p>为了获得更好的性能，Coffee Break 公司从 DB Access 公司购买了一个 JDBC 驱动程序，其中包括实现 <code>ConnectionPoolDataSource</code> 接口的 <code>com.dbaccess.ConnectionPoolDS</code> 类。系统管理员创建该类的实例，设置其属性，并将其注册到 JNDI 命名服务。Coffee Break 从其 EJB 服务器供应商 Application Logic 公司购买了数据源类 <code>com.applogic.PooledDataSource</code>。<code>com.applogic.PooledDataSource</code> 类通过使用 <code>ConnectionPoolDataSource</code> 类 <code>com.dbaccess.ConnectionPoolDS</code> 提供的支持实现连接池。</p><p>必须首先部署 <code>ConnectionPoolDataSource</code> 对象。以下代码创建了 <code>com.dbaccess.ConnectionPoolDS</code> 的实例并设置了其属性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>com</span><span class=o>.</span><span class=na>dbaccess</span><span class=o>.</span><span class=na>ConnectionPoolDS</span> <span class=n>cpds</span> <span class=o>=</span> <span class=k>new</span> <span class=n>com</span><span class=o>.</span><span class=na>dbaccess</span><span class=o>.</span><span class=na>ConnectionPoolDS</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>cpds</span><span class=o>.</span><span class=na>setServerName</span><span class=o>(</span><span class=s>&#34;creamer&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>cpds</span><span class=o>.</span><span class=na>setDatabaseName</span><span class=o>(</span><span class=s>&#34;COFFEEBREAK&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>cpds</span><span class=o>.</span><span class=na>setPortNumber</span><span class=o>(</span><span class=mi>9040</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>cpds</span><span class=o>.</span><span class=na>setDescription</span><span class=o>(</span><span class=s>&#34;Connection pooling for &#34;</span> <span class=o>+</span> <span class=s>&#34;COFFEEBREAK DBMS&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>部署 <code>ConnectionPoolDataSource</code> 对象后，系统管理员将部署 <code>DataSource</code> 对象。以下代码将 <code>com.dbaccess.ConnectionPoolDS</code> 对象 <code>cpds</code> 注册到 JNDI 命名服务。请注意，与 <code>cpds</code> 变量关联的逻辑名称已将子上下文池添加到子上下文 JDBC 下，这类似于在分级文件系统中将子目录添加到另一个子目录。<code>com.dbaccess.ConnectionPoolDS</code> 类实例的逻辑名称总是以 <code>jdbc/pool</code> 开头。Oracle 建议将所有 <code>ConnectionPoolDataSource</code> 对象放在子上下文 <code>jdbc/pool</code> 下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>Context</span> <span class=n>ctx</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ctx</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=s>&#34;jdbc/pool/fastCoffeeDB&#34;</span><span class=o>,</span> <span class=n>cpds</span><span class=o>);</span>
</span></span></code></pre></div><p>接下来，部署 <code>DataSource</code> 类，该类用于与 <code>cpds</code> 变量和 <code>com.dbaccess.ConnectionPoolDS</code> 类的其他实例交互。以下代码创建了该类的一个实例并设置了其属性。请注意 <code>com.applogic.PooledDataSource</code> 实例只设置了两个属性。设置 <code>description</code> 属性是因为它总是必需的。另一个被设置的属性 <code>dataSourceName</code> 给出了 <code>cpds</code> 的逻辑 JNDI 名称，它是 <code>com.dbaccess.ConnectionPoolDS</code> 类的一个实例。换句话说，<code>cpds</code> 代表 <code>ConnectionPoolDataSource</code> 对象，并为 <code>DataSource</code> 对象实现连接池。</p><p>部署工具可能会执行以下代码，创建 <code>PooledDataSource</code> 对象、设置其属性并将其绑定到逻辑名称 <code>jdbc/fastCoffeeDB</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>com</span><span class=o>.</span><span class=na>applogic</span><span class=o>.</span><span class=na>PooledDataSource</span> <span class=n>ds</span> <span class=o>=</span> <span class=k>new</span> <span class=n>com</span><span class=o>.</span><span class=na>applogic</span><span class=o>.</span><span class=na>PooledDataSource</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=na>setDescription</span><span class=o>(</span><span class=s>&#34;produces pooled connections to COFFEEBREAK&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=na>setDataSourceName</span><span class=o>(</span><span class=s>&#34;jdbc/pool/fastCoffeeDB&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Context</span> <span class=n>ctx</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ctx</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=s>&#34;jdbc/fastCoffeeDB&#34;</span><span class=o>,</span> <span class=n>ds</span><span class=o>);</span>
</span></span></code></pre></div><p>此时，会部署一个 <code>DataSource</code> 对象，应用程序可从该数据源对象中获得与数据库 COFFEEBREAK 的池连接。</p><h2 id=获取并使用池化连接>获取并使用池化连接</h2><p>连接池是数据库连接对象的缓存。这些对象表示应用程序可以用来连接到数据库的物理连接。在运行时，应用程序从池中获取连接。如果池中包含可以满足请求的连接，则将连接返回给应用程序。如果未找到连接，则会创建一个新连接并将其返回给应用程序。应用程序使用该连接对数据库执行一些工作，然后将对象返回到池中。 然后该连接可用于下一个连接请求。</p><p>连接池促进了连接对象的重用，减少了连接对象的创建次数。连接池显著提高了数据库密集型应用程序的性能，因为创建连接对象在时间和资源方面都非常昂贵。</p><p>现在已经部署了这些 <code>DataSource</code> 和 <code>ConnectionPoolDataSource</code> 对象，程序员可以使用 <code>DataSource</code> 对象来获取池连接。获取池化连接的代码与获取非池化连接的代码类似，如以下两行所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>ctx</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ds</span> <span class=o>=</span> <span class=o>(</span><span class=n>DataSource</span><span class=o>)</span><span class=n>ctx</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=s>&#34;jdbc/fastCoffeeDB&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>变量 <code>ds</code> 表示一个 <code>DataSource</code> 对象，该对象可以生成到数据库 <code>COFFEEBREAK</code> 的池连接。你只需检索一次该数据源对象，因为你可以使用它来生成所需的任意多个池连接。对 <code>ds</code> 变量调用 <code>getConnection</code> 方法会自动生成池连接，因为 <code>ds</code> 变量表示的 <code>DataSource</code> 对象已配置为生成池连接。</p><p>连接池通常对程序员来说是透明的。使用池连接时，只需要做两件事：</p><ol><li>使用 <code>DataSource</code> 对象而不是 <code>DriverManager</code> 类获取连接。在以下代码行中，<code>ds</code> 是一个已实现和部署的 <code>DataSource</code> 对象，以便使用此对象创建池连接，用户名和密码是表示有权访问数据库的用户凭据的变量:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>Connection</span> <span class=n>con</span> <span class=o>=</span> <span class=n>ds</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span></code></pre></div><ol start=2><li>使用 <code>finally</code> 语句关闭池化连接。下边的 <code>finally</code> 块适合使用池连接的代码的 <code>try/catch</code> 块之后：</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Connection</span> <span class=n>con</span> <span class=o>=</span> <span class=n>ds</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ... code to use the pooled
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// connection con
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ... code to handle exceptions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>con</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=n>con</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>否则，使用连接池的应用程序与使用常规连接的应用程序相同。当使用连接池时，应用程序程序员可能会注意到的唯一另一件事是性能更好。</p><p>以下示例代码获取一个 <code>DataSource</code> 对象，该对象生成与数据库 <code>COFFEEBREAK</code> 的连接，并使用它来更新表 <code>COFFEES</code> 中的价格：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.sql.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>javax.sql.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>javax.ejb.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>javax.naming.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ConnectionPoolingBean</span> <span class=kd>implements</span> <span class=n>SessionBean</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>ejbCreate</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>CreateException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ds</span> <span class=o>=</span> <span class=o>(</span><span class=n>DataSource</span><span class=o>)</span><span class=n>ctx</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=s>&#34;jdbc/fastCoffeeDB&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updatePrice</span><span class=o>(</span><span class=kt>float</span> <span class=n>price</span><span class=o>,</span> <span class=n>String</span> <span class=n>cofName</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>String</span> <span class=n>username</span><span class=o>,</span> <span class=n>String</span> <span class=n>password</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>SQLException</span><span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Connection</span> <span class=n>con</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>PreparedStatement</span> <span class=n>pstmt</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>con</span> <span class=o>=</span> <span class=n>ds</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>con</span><span class=o>.</span><span class=na>setAutoCommit</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pstmt</span> <span class=o>=</span> <span class=n>con</span><span class=o>.</span><span class=na>prepareStatement</span><span class=o>(</span><span class=s>&#34;UPDATE COFFEES &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;SET PRICE = ? &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;WHERE COF_NAME = ?&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pstmt</span><span class=o>.</span><span class=na>setFloat</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=n>price</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pstmt</span><span class=o>.</span><span class=na>setString</span><span class=o>(</span><span class=mi>2</span><span class=o>,</span> <span class=n>cofName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pstmt</span><span class=o>.</span><span class=na>executeUpdate</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>con</span><span class=o>.</span><span class=na>commit</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>pstmt</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>con</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=n>con</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>DataSource</span> <span class=n>ds</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Context</span> <span class=n>ctx</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>此代码示例中的连接参与连接池，因为以下情况成立：</p><ol><li>已部署实现 <code>ConnectionPoolDataSource</code> 的类的实例。</li><li>已部署实现 <code>DataSource</code> 的类的实例，并且为其 <code>dataSourceName</code> 属性设置的值是绑定到先前部署的 <code>ConnectionPoolDataSource</code> 对象的逻辑名称。</li></ol><p>请注意，虽然此代码与您之前见过的代码非常相似，但它在以下方面有所不同：</p><ul><li><p>除了 <code>java.sql</code> 之外，它还导入 <code>javax.sql</code>、<code>javax.ejb</code> 和 <code>javax.naming</code> 包。
<code>DataSource</code> 和 <code>ConnectionPoolDataSource</code> 接口位于 <code>javax.sql</code> 包中，JNDI 构造函数 <code>InitialContext</code> 和方法 <code>Context.lookup</code> 是 <code>javax.naming</code> 包的一部分。 此特定示例代码采用 EJB 组件的形式，该组件使用 <code>javax.ejb</code> 包中的 API。 此示例的目的是展示您使用池连接的方式与使用非池连接的方式相同，因此您不必担心理解 EJB API。</p></li><li><p>使用 <code>DataSource</code> 对象来获取连接，而不是使用 <code>DriverManager</code>。</p></li><li><p>使用 <code>finally</code> 块来确保连接已关闭。</p></li></ul><p>获取和使用池连接与获取和使用常规连接类似。当充当系统管理员的某人正确部署了 <code>ConnectionPoolDataSource</code> 对象和 <code>DataSource</code> 对象时，应用程序将使用该 <code>DataSource</code> 对象来获取池连接。 但是，应用程序应该使用 <code>finally</code> 块来关闭池连接。 为简单起见，前面的示例使用了 <code>finally</code> 块，但没有使用 <code>catch</code> 块。 如果 <code>try</code> 块中的方法抛出异常，则默认会抛出异常，无论如何都会执行 <code>finally</code> 子句。</p><h2 id=部署分布式事务>部署分布式事务</h2><p>可以部署 <code>DataSource</code> 对象来获取可在分布式事务中使用的连接。与连接池一样，必须部署两个不同的类实例：一个 <code>XADataSource</code> 对象和一个为了使用它而实现的 <code>DataSource</code> 对象。</p><p>假设 Coffee Break 企业家购买的 EJB 服务器包含 <code>DataSource</code> 类 <code>com.applogic.TransactionalDS</code>，它与 <code>XADataSource</code> 类（例如：<code>com.dbaccess.XATransactionalDS</code>）一起使用。 事实上，它可以与任何 <code>XADataSource</code> 类一起使用，这使得 EJB 服务器可以跨 JDBC 驱动程序移植。 当部署 <code>DataSource</code> 和 <code>XADataSource</code> 对象时，产生的连接将能够参与分布式事务。 在本例中，实现了 <code>com.applogic.TransactionalDS</code> 类，以便生成的连接也是池连接，这通常是作为 EJB 服务器实现的一部分提供的 <code>DataSource</code> 类的情况。</p><p>必须首先部署 <code>XADataSource</code> 对象。以下代码创建 <code>com.dbaccess.XATransactionalDS</code> 的实例并设置其属性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>com</span><span class=o>.</span><span class=na>dbaccess</span><span class=o>.</span><span class=na>XATransactionalDS</span> <span class=n>xads</span> <span class=o>=</span> <span class=k>new</span> <span class=n>com</span><span class=o>.</span><span class=na>dbaccess</span><span class=o>.</span><span class=na>XATransactionalDS</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>xads</span><span class=o>.</span><span class=na>setServerName</span><span class=o>(</span><span class=s>&#34;creamer&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>xads</span><span class=o>.</span><span class=na>setDatabaseName</span><span class=o>(</span><span class=s>&#34;COFFEEBREAK&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>xads</span><span class=o>.</span><span class=na>setPortNumber</span><span class=o>(</span><span class=mi>9040</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>xads</span><span class=o>.</span><span class=na>setDescription</span><span class=o>(</span><span class=s>&#34;Distributed transactions for COFFEEBREAK DBMS&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>以下代码使用 JNDI 命名服务注册 <code>com.dbaccess.XATransactionalDS</code> 对象 <code>xads</code>。请注意，与 <code>xads</code> 关联的逻辑名称在 jdbc 下添加了子上下文 <code>xa</code>。 Oracle 建议 <code>com.dbaccess.XATransactionalDS</code> 类的任何实例的逻辑名称始终以 <code>jdbc/xa</code> 开头。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>Context</span> <span class=n>ctx</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ctx</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=s>&#34;jdbc/xa/distCoffeeDB&#34;</span><span class=o>,</span> <span class=n>xads</span><span class=o>);</span>
</span></span></code></pre></div><p>接下来，部署实现与 <code>xad</code> 和其他 <code>XADataSource</code> 对象交互的 <code>DataSource</code> <code>对象。请注意，DataSource</code> 类 <code>com.applogic.TransactionalDS</code> 可以与任何 JDBC 驱动程序供应商的 <code>XADataSource</code> 类一起使用。 部署 <code>DataSource</code> 对象涉及创建 <code>com.applogic.TransactionalDS</code> 类的实例并设置其属性。<code>dataSourceName</code> 属性设置为 <code>jdbc/xa/distCoffeeDB</code>，即与 <code>com.dbaccess.XATransactionalDS</code> 关联的逻辑名称。这是 <code>XADataSource</code> 类，它为 <code>DataSource</code> 类实现分布式事务功能。以下代码部署 <code>DataSource</code> 类的实例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>com</span><span class=o>.</span><span class=na>applogic</span><span class=o>.</span><span class=na>TransactionalDS</span> <span class=n>ds</span> <span class=o>=</span> <span class=k>new</span> <span class=n>com</span><span class=o>.</span><span class=na>applogic</span><span class=o>.</span><span class=na>TransactionalDS</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=na>setDescription</span><span class=o>(</span><span class=s>&#34;Produces distributed transaction &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                  <span class=s>&#34;connections to COFFEEBREAK&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=na>setDataSourceName</span><span class=o>(</span><span class=s>&#34;jdbc/xa/distCoffeeDB&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Context</span> <span class=n>ctx</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>ctx</span><span class=o>.</span><span class=na>bind</span><span class=o>(</span><span class=s>&#34;jdbc/distCoffeeDB&#34;</span><span class=o>,</span> <span class=n>ds</span><span class=o>);</span>
</span></span></code></pre></div><p>现在已经部署了 <code>com.applogic.TransactionalDS</code> 和 <code>com.dbaccess.XATransactionalDS</code> 类的实例，应用程序可以在 <code>TransactionalDS</code> 类的实例上调用 <code>getConnection</code> 方法来获取与可在分布式事务中使用的 <code>COFFEEBREAK</code> 数据库的连接。</p><h2 id=使用连接进行分布式事务>使用连接进行分布式事务</h2><p>要获得可用于分布式事务的连接，必须使用已正确实现和部署的 <code>DataSource</code> 对象，如部署分布式事务部分所示。 对于这样的 <code>DataSource</code> 对象，调用它的 <code>getConnection</code> 方法。 建立连接后，就像使用任何其他连接一样使用它。由于 <code>jdbc/distCoffeesDB</code> 已与 JNDI 命名服务中的 <code>XADataSource</code> 对象关联，因此以下代码生成可在分布式事务中使用的 <code>Connection</code> 对象：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>Context</span> <span class=n>ctx</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>DataSource</span> <span class=n>ds</span> <span class=o>=</span> <span class=o>(</span><span class=n>DataSource</span><span class=o>)</span><span class=n>ctx</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=s>&#34;jdbc/distCoffeesDB&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span> <span class=n>con</span> <span class=o>=</span> <span class=n>ds</span><span class=o>.</span><span class=na>getConnection</span><span class=o>();</span>
</span></span></code></pre></div><p>当此连接作为分布式事务的一部分时，对其使用方式有一些次要但重要的限制。事务管理器控制分布式事务何时开始以及何时提交或回滚；因此，应用程序代码决不应该调用 <code>Connection.commit</code> 或 <code>Connection.rollback</code> 方法。应用程序同样不应该调用 <code>Connection.setAutoCommit(true)</code>，这会启用自动提交模式，因为这也会干扰事务管理器对事务边界的控制。这解释了为什么在分布式事务范围内创建的新连接默认禁用其自动提交模式。请注意，这些限制仅在连接参与分布式事务时适用；当连接不是分布式事务的一部分时，没有任何限制。</p><p>对于以下示例，假设订单的咖啡已发货，这会触发对驻留在不同 DBMS 服务器上的两个表的更新。 第一个表是新的 <code>INVENTORY</code> 表，第二个表是 <code>COFFEES</code> 表。 由于这些表位于不同的 DBMS 服务器上，因此涉及它们的事务将是分布式事务。 以下示例中的代码获取连接、更新 <code>COFFEES</code> 表并关闭连接，是分布式事务的第二部分。</p><p>请注意，代码不会显式提交或回滚更新，因为分布式事务的范围由中间层服务器的底层系统基础结构控制。此外，假设用于分布式事务的连接是池连接，则应用程序使用 <code>finally</code> 块来关闭连接。这样保证了即使抛出异常也会关闭有效的连接，从而保证连接返回到连接池中被回收。</p><p>以下代码示例说明了一个企业 Bean，它是一个实现可由客户端计算机调用的方法的类。此示例的目的是演示分布式事务的应用程序代码与其他代码没有什么不同，只是它不调用 <code>Connection</code> 方法 <code>commit</code>、<code>rollback</code> 或 <code>setAutoCommit(true)</code>。因此，您无需担心了解所使用的 EJB API。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.sql.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>javax.sql.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>javax.ejb.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>javax.naming.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DistributedTransactionBean</span> <span class=kd>implements</span> <span class=n>SessionBean</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>ejbCreate</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>CreateException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ctx</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InitialContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>ds</span> <span class=o>=</span> <span class=o>(</span><span class=n>DataSource</span><span class=o>)</span><span class=n>ctx</span><span class=o>.</span><span class=na>lookup</span><span class=o>(</span><span class=s>&#34;jdbc/distCoffeesDB&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateTotal</span><span class=o>(</span><span class=kt>int</span> <span class=n>incr</span><span class=o>,</span> <span class=n>String</span> <span class=n>cofName</span><span class=o>,</span> <span class=n>String</span> <span class=n>username</span><span class=o>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>String</span> <span class=n>password</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Connection</span> <span class=n>con</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>PreparedStatement</span> <span class=n>pstmt</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>con</span> <span class=o>=</span> <span class=n>ds</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pstmt</span> <span class=o>=</span> <span class=n>con</span><span class=o>.</span><span class=na>prepareStatement</span><span class=o>(</span><span class=s>&#34;UPDATE COFFEES &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;SET TOTAL = TOTAL + ? &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;WHERE COF_NAME = ?&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pstmt</span><span class=o>.</span><span class=na>setInt</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=n>incr</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pstmt</span><span class=o>.</span><span class=na>setString</span><span class=o>(</span><span class=mi>2</span><span class=o>,</span> <span class=n>cofName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>pstmt</span><span class=o>.</span><span class=na>executeUpdate</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>stmt</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>con</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=n>con</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>DataSource</span> <span class=n>ds</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Context</span> <span class=n>ctx</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><hr><h1 id=处理-sql-异常>处理 SQL 异常</h1><h2 id=sqlexception-概述><code>SQLException</code> 概述</h2><p>当 JDBC 与数据库交互遇到错误时，它抛出一个 <code>SQLException</code> 实例而不是 <code>Exception</code>。此上下文中的数据源表示 <code>Connection</code> 对象所连接的数据库。<code>SQLException</code> 实例包含以下信息，可以帮助你推断造成错误的原因：</p><ul><li>错误的描述。通过调用 <code>SQLException.getMessage</code> 方法获取 <code>String</code> 类型的描述。</li><li><code>SQLState</code> 代码。这些代码及其含义已由 ISO/ANSI 和 Open Group (X/Open) 标准化，尽管有些代码已保留给数据库供应商自行定义。该 <code>String</code> 对象由五个字母数字字符组成。通过调用 <code>SQLException.getSQLState</code> 方法获取此代码。</li><li>引起此异常的原因。<code>SQLException</code> 实例可能具有因果关系，该关系由导致抛出 <code>SQLException</code> 实例的一个或多个 <code>Throwable</code> 对象组成。要获取此原因链，递归地调用 <code>SQLException.getCause</code> 方法直到返回 <code>null</code> 值。</li><li>对任何链式（chained）异常的引用。如果发生多个错误，则通过该链引用异常。通过对引发的异常调用方法 <code>SQLException.getNextException</code> 来获取异常。</li></ul><h2 id=获取异常>获取异常</h2><hr><h1 id=使用-preparedstatement>使用 <code>PreparedStatement</code></h1><h2 id=preparedstatement-概述><code>PreparedStatement</code> 概述</h2><p>在某些情况下，使用 <code>PreparedStatement</code> 对象向数据库发送 SQL 语句更加方便。这种特殊类型的语句派生自更通用的 <code>Statement</code> 类。</p></article></main><footer id=footer></footer></body></html>